# v1.5.9 调试信息增强修改计划

**制定时间**: 2026-02-02
**版本**: v1.5.9 → v1.5.10
**目标**: 完善调试信息面板，便于后续问题监测和发现

---

## 修改前分析

### 问题1: 调试信息缺少文件名标识

**现状**:
```
[10:15:26] 目录提取: ========== 开始提取目录 ==========
[10:15:26] 目录提取: 输入内容长度: 37411
```

**问题**: 不知道这些日志对应哪个MD文件

**分析**:
- extractHeadings(content) 只接收 content 参数
- handleFileLoad 中有 fileName，但没有传递给 extractHeadings
- 需要在 extractHeadings 开头添加文件名信息

**修改方案**:
1. 修改 extractHeadings(content) → extractHeadings(content, fileName)
2. 在 handleFileLoad 中传递 currentFileName
3. 在 extractHeadings 开头添加 `addDebugInfo('目录提取', '读取文件: ' + fileName)`

**影响范围**:
- 只影响目录提取日志显示
- 不影响功能逻辑
- 向后兼容（fileName可选）

**风险评估**: ⭐ 极低

---

### 问题2: console.log vs 调试面板

**用户问题**: 
```javascript
console.log('【第一层防御】语法预检失败，跳过渲染:', validation.error);
```
这个是否输出到调试信息面板？

**答案**: **否**
- console.log 只输出到浏览器控制台（F12可见）
- 要输出到调试面板，必须使用 `window.addDebugInfo(category, message)`
- 当前第一层防御失败时，只调用 showErrorNotification，没有调用 addDebugInfo

**修改方案**:
1. 在第一层防御失败时，添加 addDebugInfo 调用
2. 统一日志输出渠道（优先使用 addDebugInfo）

**位置**: index.html:1130-1138（第一层防御代码块）

**代码示例**:
```javascript
if (!validation.valid) {
    showErrorNotification('图表 #' + (i + 1) + ' 语法验证失败', validation.error);
    if (window.addDebugInfo) window.addDebugInfo('第一层防御', '语法预检失败，跳过图表 #' + (i+1) + ': ' + validation.error);
    // ...
}
```

**风险评估**: ⭐ 极低（仅添加日志）

---

### 问题3: 为5个辅助函数添加进入/退出日志

**目标函数**:
1. escapeHtml(text)
2. showErrorNotification(message, details)
3. cleanupMermaidErrorElements(chartId)
4. validateMermaidCode(code)
5. checkAndCleanupMermaidError(element)

**分析**:
- 这些函数都是辅助函数，可能在多处被调用
- 添加进入/退出日志有助于追踪调用流程
- 需要防止过度日志影响性能（函数内部循环不重复记录）

**修改方案**:
每个函数修改为以下模式：
```javascript
function functionName(param) {
    if (window.addDebugInfo) window.addDebugInfo('函数名', '【进入】参数: ' + JSON.stringify(param).substring(0, 50));
    
    // 原有代码...
    
    if (window.addDebugInfo) window.addDebugInfo('函数名', '【退出】返回值/结果');
    return result;
}
```

**具体修改位置**:
- escapeHtml: index.html:983
- showErrorNotification: index.html:993
- cleanupMermaidErrorElements: index.html:1032
- validateMermaidCode: index.html:1010
- checkAndCleanupMermaidError: index.html:1053

**风险评估**: ⭐ 低（添加日志，不影响功能）

---

### 问题4: 多错误处理增强

**用户问题**: 
> 62-75 行这里是处理一个 error 还是处理多个 error？
> 如果在 mermaid render 出现多个 error 也是有可能的

**现状分析**:
```javascript
for (let i = 0; i < mermaidCodeBlocks.length; i++) {
    // ...
    try {
        await mermaid.render(chartId, fixedCode);
        // 成功处理
    } catch (renderError) {
        // 处理单个图表错误
        failedCharts.push(errorInfo);
        // 继续下一个（continue）
    }
}
```

**当前行为**:
- ✅ 循环处理每个图表
- ✅ 每个错误都被 catch 并记录到 failedCharts
- ✅ 继续处理下一个图表（不会中断）
- ✅ 最后统一显示统计信息

**需要增强的地方**:
1. 调试日志不够详细（每个错误只记录一条）
2. 没有记录错误统计汇总
3. 可以添加更多上下文信息（如当前是哪个文件）

**修改方案**:
1. 在循环开始处添加当前处理进度日志
2. 在每个错误处理处添加详细日志
3. 在循环结束时添加汇总日志
4. 添加 failedCharts 的内容日志

**示例**:
```javascript
if (window.addDebugInfo) window.addDebugInfo('Mermaid渲染', '开始批量渲染，共 ' + mermaidCodeBlocks.length + ' 个图表');

for (...) {
    if (window.addDebugInfo) window.addDebugInfo('Mermaid渲染', '处理图表 #' + (i+1) + '/' + mermaidCodeBlocks.length);
    // ...
    catch (e) {
        if (window.addDebugInfo) window.addDebugInfo('Mermaid渲染', '图表 #' + (i+1) + ' 错误: ' + e.message);
    }
}

if (window.addDebugInfo) window.addDebugInfo('Mermaid渲染', '批量渲染完成，成功: ' + successCount + ', 失败: ' + failedCharts.length);
if (failedCharts.length > 0 && window.addDebugInfo) {
    window.addDebugInfo('Mermaid渲染', '失败详情: ' + JSON.stringify(failedCharts, null, 2));
}
```

**风险评估**: ⭐ 低（增强日志，不影响功能）

---

## 修改顺序和依赖关系

```
问题1 (文件名) 
    ↓
问题2 (第一层防御日志) - 依赖问题1的文件名上下文
    ↓
问题4 (多错误增强) - 依赖问题1的文件名
    ↓
问题3 (辅助函数日志) - 独立，最后做
```

---

## 回退方案

如果出现问题，可回退到:
```bash
cp backup/v1.5.9_before_debug_enhanced_20260202_1537/index.html static/index.html
```

---

**计划制定人**: OpenCode AI Assistant
**状态**: ✅ 分析完成，准备实施
