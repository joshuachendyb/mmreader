# 软件项目代码回滚操作规则

**创建时间**: 2026-02-03 07:51:07
**更新时间**: 2026-02-03 07:51:07
**适用范围**: 所有软件项目代码迭代过程中的版本回滚操作
**规则版本**: v1.0.0

---

## 1. 总则

### 1.1 目的

本规则旨在规范软件项目代码迭代过程中出现严重问题时的回滚操作，确保：
- 快速恢复到稳定版本
- 避免版本混乱和文件遗漏
- 保证回滚过程可追踪、可审计
- 减少人为操作失误

### 1.2 适用场景

- 新版本构建后出现严重功能缺陷
- 新版本导致系统无法启动或崩溃
- 新版本引入安全漏洞
- 新版本性能严重下降
- 其他需要放弃当前修改、恢复历史版本的情况

### 1.3 核心原则

**黄金法则**: 回滚操作必须完整、准确、可追溯。

---

## 2. 回滚前准备

### 2.1 问题确认

**必须明确以下信息**：

| 检查项 | 要求 | 示例 |
|--------|------|------|
| **问题版本** | 精确到版本号 | v1.5.10 |
| **问题描述** | 具体问题表现 | 窗口无法显示、功能失效等 |
| **目标版本** | 最后已知稳定的版本 | v1.5.9 |
| **回滚范围** | 影响哪些文件 | index.html, main.go等 |

**禁止行为**: 使用模糊描述如"回滚到之前的版本"、"用昨天的代码"。

### 2.2 备份当前状态

即使当前版本有问题，也必须备份：

```bash
# 创建备份目录（命名规范）
mkdir -p backup/v{问题版本}_before_rollback_YYYYMMDD_HHMM

# 复制所有相关文件
cp static/index.html backup/v{问题版本}_before_rollback_YYYYMMDD_HHMM/
cp main.go backup/v{问题版本}_before_rollback_YYYYMMDD_HHMM/
cp version.txt backup/v{问题版本}_before_rollback_YYYYMMDD_HHMM/
# ... 其他文件
```

**备份目录命名规范**: `vX.Y.Z_before_rollback_YYYYMMDD_HHMM`

---

## 3. 回滚操作步骤

### 3.1 步骤一：确定回滚源

**操作要求**:
1. 查看调试笔记，确认目标版本的最后稳定备份
2. 验证备份完整性（文件是否存在、时间是否正确）
3. 记录回滚源路径

**示例**:
```
回滚源: backup/v1.5.9_stable_working_20260202_1537/
目标版本: v1.5.9
```

### 3.2 步骤二：完整回滚所有文件

**必须回滚的文件清单**:

#### A. 前端代码文件
- [ ] `static/index.html` - 主HTML文件
- [ ] `static/js/*.js` - JavaScript文件
- [ ] `static/css/*.css` - 样式文件
- [ ] `static/img/*` - 图片资源

#### B. 后端代码文件
- [ ] `main.go` - 主程序入口
- [ ] `app.go` - 应用逻辑（如存在）
- [ ] 其他 `.go` 文件

#### C. 版本号文件
- [ ] `version.txt` - 版本号记录
- [ ] `main.go` 中的版本号字符串

#### D. 配置文件
- [ ] `wails.json` - Wails配置
- [ ] `go.mod` - Go模块定义
- [ ] `go.sum` - Go依赖校验

**回滚命令示例**:
```bash
cd {项目目录}

# 回滚前端
cp backup/v1.5.9_stable_working_20260202_1537/static/index.html static/

# 回滚后端
cp backup/v1.5.9_stable_working_20260202_1537/main.go ./

# 回滚版本号
cp backup/v1.5.9_stable_working_20260202_1537/version.txt ./
```

**关键警告**: 
- ❌ **禁止**只回滚部分文件
- ❌ **禁止**混合不同版本的文件
- ✅ **必须**回滚所有相关文件

### 3.3 步骤三：版本号管理

**回滚场景的版本号处理**:

```
当前问题版本: v1.5.10（有bug）
目标稳定版本: v1.5.9（正常）
回滚后版本号: 1.5.9（保持目标版本号不变）
```

**版本号设置检查**:
- [ ] `main.go` 中的 `return "X.Y.Z"` 与目标版本一致
- [ ] `version.txt` 内容与目标版本一致
- [ ] 前端代码中硬编码的版本号（如有）与目标版本一致

### 3.4 步骤四：构建方式选择

**回滚场景必须使用以下方式**:

```bash
# 1. 进入项目目录
cd {项目目录}/gobuild

# 2. 直接执行 wails build（不使用构建脚本）
wails build

# 3. 手动复制到bin目录
cp build/bin/MermaidReader.exe bin/
```

**为什么不用 build-dev.bat?**
- build-dev.bat 会自动升级版本号（PATCH+1）
- 回滚应该保持目标版本号不变
- 使用 `wails build` 保持当前版本号

---

## 4. 验证流程（四步验证法）

### 4.1 第一步：代码验证

**验证清单**:
- [ ] 所有文件已正确回滚（对比文件修改时间）
- [ ] 语法检查通过（JavaScript/Go等）
- [ ] 版本号一致（main.go、version.txt、前端代码）

**JavaScript语法检查命令**:
```bash
node -e "const fs=require('fs'); const html=fs.readFileSync('static/index.html','utf8'); const scripts=html.match(/<script>([\s\S]*?)<\/script>/g); scripts.forEach((script,i)=>{const code=script.replace(/<script>/g,'').replace(/<\/script>/g,''); try{new Function(code); console.log('✅ Script '+(i+1)+' OK');}catch(e){console.log('❌ Script '+(i+1)+' Error:',e.message);}});"
```

### 4.2 第二步：构建验证

**验证清单**:
- [ ] 构建命令执行成功（无错误）
- [ ] 输出文件存在 `build/bin/*`
- [ ] 文件大小合理（与历史版本对比）

### 4.3 第三步：功能验证

**验证清单**:
- [ ] 应用能正常启动并显示窗口
- [ ] 版本号显示正确（关于页面或标题栏）
- [ ] 核心功能正常（文件打开、渲染、保存等）
- [ ] 无异常崩溃或错误提示

### 4.4 第四步：备份验证

**验证清单**:
- [ ] 回滚前的问题版本已备份
- [ ] 备份目录命名规范
- [ ] 备份文件完整

---

## 5. 禁止事项清单

| 序号 | 禁止行为 | 后果 | 正确做法 |
|------|---------|------|---------|
| 1 | 凭记忆选择备份目录 | 选错版本，回滚失败 | 查看调试笔记确认 |
| 2 | 只回滚部分文件 | 版本混乱，功能异常 | 完整回滚所有文件 |
| 3 | 混合不同版本文件 | 不可预知的错误 | 全部使用同一版本 |
| 4 | 使用build-dev.bat回滚 | 版本号自动升级，与目标不符 | wails build + 手动复制 |
| 5 | 忽略构建错误 | 运行时不稳定 | 解决所有错误再交付 |
| 6 | 不验证就交付 | 隐藏问题未被发现 | 严格执行四步验证 |
| 7 | 不记录回滚操作 | 无法追溯，无法学习 | 详细记录回滚过程 |

---

## 6. 回滚操作流程图

```
┌─────────────────────────────────────────────────────────────┐
│  发现问题                                                  │
│  示例：v1.5.10窗口无法显示                                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  确定回滚目标                                              │
│  示例：回滚到v1.5.9（最后稳定版本）                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  备份当前代码（即使有问题）                                   │
│  backup/v1.5.10_before_rollback_20260203_0751/              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  完整回滚所有文件                                           │
│  - static/index.html                                        │
│  - main.go                                                  │
│  - version.txt                                              │
│  - 其他相关文件                                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  手动设置版本号                                             │
│  main.go: return "1.5.9"                                    │
│  version.txt: 1.5.9                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  使用 wails build 构建                                      │
│  （不使用build-dev.bat）                                     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  四步验证                                                  │
│  ✅ 代码验证                                               │
│  ✅ 构建验证                                               │
│  ✅ 功能验证                                               │
│  ✅ 备份验证                                               │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  测试通过 ✓                                                │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  更新调试笔记                                               │
│  记录回滚原因、过程、经验教训                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 回滚记录模板

每次回滚操作必须在项目调试笔记中记录，使用以下模板：

```markdown
## 回滚记录 - v{目标版本}

**时间**: YYYY-MM-DD HH:MM:SS
**操作人**: {姓名}

### 7.1 问题描述

**问题版本**: vX.Y.Z
**问题现象**: （详细描述问题表现）
**影响范围**: （影响哪些功能）
**严重程度**: （高/中/低）

### 7.2 回滚信息

**目标版本**: vX.Y.Z
**回滚源**: `backup/vX.Y.Z_YYYYMMDD_HHMM/`
**回滚文件清单**:
- [x] static/index.html
- [x] main.go
- [x] version.txt
- [x] （其他文件）

### 7.3 验证结果

- [x] 代码验证：语法检查通过
- [x] 构建验证：构建成功
- [x] 功能验证：核心功能正常
- [x] 版本号验证：显示 vX.Y.Z
- [x] 备份验证：问题版本已备份

### 7.4 经验教训

**问题原因**: （为什么会出现这个问题）
**预防措施**: （如何避免再次发生）
**改进建议**: （流程、工具等方面的改进）

---

**状态**: ✅ 回滚完成，系统恢复正常
```

---

## 8. 常见问题FAQ

### Q1: 不确定要回滚到哪个版本怎么办？

**A**: 查看调试笔记，找到最后一个标记"✅ 稳定"、"✅ 测试通过"的版本。如果笔记不清晰，查看备份目录的时间戳，选择问题发生前的最后一个备份。

### Q2: 回滚后发现还是不行？

**A**: 检查：
1. 是否完整回滚了所有文件？
2. 版本号是否设置正确？
3. 是否使用了正确的构建方式？
4. 是否存在缓存（删除build目录重新构建）？

### Q3: 可以回滚到任意历史版本吗？

**A**: 理论上可以，但建议：
- 优先选择最近的稳定版本
- 回滚跨度不要太大（避免兼容性问题）
- 确保备份完整

### Q4: 回滚后如何继续开发？

**A**: 
1. 基于回滚后的版本继续开发
2. 修复导致回滚的问题
3. 使用build-dev.bat正常迭代到下一个版本
4. 不要重复之前导致问题的修改

### Q5: 多人协作时如何回滚？

**A**: 
1. 在团队沟通群中通知所有人
2. 统一回滚操作（一个人执行，其他人同步）
3. 更新版本控制（Git commit: "Rollback to vX.Y.Z"）
4. 通知团队成员拉取最新代码

---

## 9. 附录

### 9.1 相关文档

- 软件代码迭代规则
- 软件版本号变更管理规定
- 项目调试笔记规范

### 9.2 工具命令速查

```bash
# JavaScript语法检查
node -e "const fs=require('fs'); const html=fs.readFileSync('static/index.html','utf8'); const scripts=html.match(/<script>([\s\S]*?)<\/script>/g); scripts.forEach((script,i)=>{const code=script.replace(/<script>/g,'').replace(/<\/script>/g,''); try{new Function(code); console.log('✅ Script '+(i+1)+' OK');}catch(e){console.log('❌ Script '+(i+1)+' Error:',e.message);}});"

# 构建
wails build

# 复制到bin（手动）
cp build/bin/MermaidReader.exe bin/

# 查看版本号（Go）
grep "return.*1\.5\." main.go
```

### 9.3 版本号说明

- **MAJOR**: 重大版本变更（如架构重构）
- **MINOR**: 新增功能模块
- **PATCH**: Bug修复、优化

回滚操作通常不改变版本号，保持目标版本的版本号。

---

**文档维护**: 每次回滚操作后，根据实践经验更新本规则。
**生效日期**: 2026-02-03
**下次评审**: 2026-03-03
