# 软件代码Bug修复和增加功能代码经验总结

**文档创建时间**: 2026-01-31 20:35:00  
**适用场景**: 在现有代码基础上修复Bug或增加新功能  
**核心原则**: 不求快，只求稳

---

## 一、本次成功案例概述

**项目**: MermaidReader v1.4.0 UI界面美化  
**修改内容**:
- 深蓝灰专业风格颜色方案
- 按钮圆角、渐变、悬浮动画
- 左侧目录栏Tab切换功能

**结果**: 8个实施步骤，零错误，一次成功

---

## 二、核心经验（按重要性排序）

### 1. **先分析，再动手（最重要）**

**错误做法**:
- 看到需求就直接改代码
- 不读原有代码逻辑
- 凭感觉写新代码

**正确做法**:
```
步骤1: 完整读取要修改的文件
步骤2: 画出代码结构图（ mentally ）
步骤3: 找出关键函数和变量
步骤4: 标记哪些不能动，哪些可以改
步骤5: 规划修改方案
步骤6: 最后才开始写代码
```

**本次实践**:
- 先读取index.html完整结构
- 分析工具栏、侧边栏、CSS变量的对应关系
- 确定修改不会影响原有功能
- 规划8个步骤，每步只改一处

---

### 2. **分步骤实施，每次只改一处**

**错误做法**:
- 一次性改CSS、HTML、JS
- 改完发现报错，不知道哪处出错
- 到处救火，越改越乱

**正确做法**:
```
步骤1: 备份当前代码
步骤2: 修改CSS变量（只改颜色值）
步骤3: 验证语法正确
步骤4: 修改按钮样式（只改.btn类）
步骤5: 验证按钮显示正常
步骤6: 修改HTML结构（只改sidebar）
步骤7: 验证DOM结构正确
步骤8: 添加JS逻辑
步骤9: 最终测试
```

**本次实践**:
- 严格分8个步骤
- 每步完成都标记状态
- 不跳步，不并行
- 每步结束都检查语法

---

### 3. **修改前必备份**

**错误做法**:
- 直接在当前文件上修改
- 改崩了无法恢复
- 只能重头再来

**正确做法**:
```bash
# 修改前
mkdir backup/v1.4.0_before_ui
cp index.html backup/v1.4.0_before_ui/
cp main.go backup/v1.4.0_before_ui/
```

**本次实践**:
- 第一步就是完整备份
- 备份内容包括所有可能受影响的文件
- 创建backup_info.txt记录备份原因

---

### 4. **不改结构，只改值**

**安全原则**:
- CSS: 只改颜色值，不改变量名
- HTML: 只改类名，不改id
- JS: 只改函数内部，不改函数签名

**危险操作**:
- 重命名CSS变量（导致其他地方引用失效）
- 删除HTML元素（导致JS找不到节点）
- 修改函数参数（导致调用处报错）

**本次实践**:
- CSS变量名全保留，只改#后面的值
- HTML结构改动最小（只加了一层div包裹）
- JS函数新增，不改原有函数

---

### 5. **参考成功范例**

**经验**:
- 如果有类似的成功代码，不要自己重新写
- 直接复制成功的实现
- 在复制的基础上微调

**本次实践**:
- 参考app.html的fixMermaidCode实现
- 发现引号处理问题直接照搬
- 避免自己重新写正则（容易出错）

---

### 6. **三思：影响范围检查**

**每次修改前问自己**:
```
1. 这个CSS类在哪些地方用到？
2. 改了这个HTML id，JS还能找到吗？
3. 这个函数被谁调用了？
4. 新加的代码会不会和原有代码冲突？
5. 出错时会不会影响其他功能？
```

**本次实践**:
- 修改前检查变量作用域
- 确认lastIndex只在循环末尾更新
- 确认新加函数不会覆盖原有函数
- 确认事件监听器不干扰Wails框架

---

### 7. **语法检查自动化**

**工具**:
- 使用IDE的语法检查（VS Code红色波浪线）
- 使用命令行工具: node -c file.js
- 使用在线工具: JSHint, ESLint

**本次实践**:
- 每步修改后用Read工具检查语法
- 确认括号、引号匹配
- 确认没有遗漏的分号

---

### 8. **功能隔离：失败不出圈**

**设计原则**:
- 每个功能独立try-catch
- 一个功能失败不影响整体
- 错误信息显示但不阻断流程

**本次实践**:
- 每个Mermaid图表独立try-catch
- 图表渲染失败显示错误但不阻断其他图表
- Tab切换失败不影响文件打开功能

---

## 三、不犯的错误清单

| 错误类型 | 后果 | 避免方法 |
|---------|------|---------|
| 一次性改多处 | 报错无法定位 | 每次只改一处，验证后再下一步 |
| 不备份就改 | 改崩了无法恢复 | 修改前必备份 |
| 删除原有代码 | 功能丢失 | 只添加新代码，不删除旧的 |
| 重命名变量 | 引用失效 | 保持变量名不变 |
| 复杂的正则表达式 | 匹配错误 | 使用简单正则，或复制成功范例 |
| 阻止框架默认行为 | 框架异常 | 不调用event.preventDefault() |
| 全局状态修改 | 竞态条件 | 使用局部变量，不修改全局状态 |
| 深层嵌套try-catch | 流程混乱 | 最多一层try-catch，保持流程清晰 |

---

## 四、可复用的工作流程

### 标准修改流程

```
准备阶段:
  ↓
1. 完整备份当前代码
  ↓
2. 读取并分析代码结构
  ↓
3. 标记可修改区域和禁区
  ↓
实施阶段:
  ↓
4. 分步骤列出修改清单
  ↓
5. 按顺序执行每个步骤
   - 修改代码
   - 语法检查
   - 逻辑验证
   - 标记完成
  ↓
6. 最终构建和测试
  ↓
收尾阶段:
  ↓
7. 对比修改前后
8. 记录修改日志
```

---

## 五、特别注意事项

### CSS修改
- ✅ 只改值: `color: #old` → `color: #new`
- ❌ 不改名: `--bg-primary` 保持不变
- ❌ 不删类: `.btn` 保留，增强样式

### HTML修改
- ✅ 只加元素: 在原有结构外加div包裹
- ❌ 不改id: `id="toc-container"` 保持不变
- ❌ 不删节点: 保留原有容器

### JS修改
- ✅ 只加函数: 新增switchSidebarTab()
- ❌ 不改原有: renderContent()逻辑保持不变
- ✅ 独立try-catch: 每个功能独立错误处理

---

## 六、验证检查表

每次修改后检查:

- [ ] 语法无错误（括号、引号匹配）
- [ ] 原有功能未被破坏
- [ ] 新功能正常工作
- [ ] 控制台无报错
- [ ] 边界情况测试通过
- [ ] 备份文件完整可用

---

## 七、总结

**核心口诀**:
```
先分析，再动手
分步骤，慢慢走
改之前，先备份
不改名，只改值
每步完，要验证
八步走，零错误
```

**本次成功的关键**:
不是技术多高超，而是**不着急、分步走、勤验证**。

复杂的功能简单化，
简单的步骤重复做，
重复的工作标准化。

---

**文档更新时间**: 2026-01-31 20:35:00
