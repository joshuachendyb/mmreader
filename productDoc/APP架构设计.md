# MermaidReader 应用程序架构设计

## 一、概述

MermaidReader 是一款专门用于渲染和展示包含 Mermaid 图表的 Markdown 文件的应用程序。它采用现代前端技术栈，提供了直观的用户界面来浏览和解析复杂的 Markdown 文档，特别是其中的 Mermaid 图表内容。应用支持浏览器环境运行。

### 核心功能
1. **文件读取**: 通过文件选择器打开本地 Markdown 文件
2. **内容显示**: 完整准确地显示 MD 文件的全部内容
3. **图表渲染**: 将 Mermaid 代码块渲染为 SVG 图形
4. **表格渲染**: 将 Markdown 表格渲染为 HTML 表格

### 设计目标
- **准确性**: MD 内容显示准确无误，Mermaid 图表渲染精准
- **快速性**: 渲染速度快，用户无需长时间等待
- **易用性**: 操作简单直观，界面清晰明了

---

## 二、核心需求定义

### 2.1 功能性需求

#### 需求编号：REQ-001 文件读取与显示
**优先级**: P0 - 核心功能

**描述**:
- 用户可以通过界面上的文件选择按钮打开本地 Markdown 文件
- 系统必须完整准确地显示 MD 文件的全部内容，包括文本、格式、特殊字符
- 支持的中文内容必须正确显示，无乱码或截断

**验收标准**:
- [ ] 文件选择按钮在界面上清晰可见
- [ ] 点击按钮后弹出系统文件选择对话框
- [ ] 支持 `.md`、`.markdown` 格式
- [ ] 文件内容完整显示，包括所有中文字符和格式

#### 需求编号：REQ-002 Mermaid图表渲染
**优先级**: P0 - 核心功能

**描述**:
- MD 文件中包含的 ```mermaid 代码块必须正确渲染为图形
- 渲染结果必须准确、清晰、位置合理
- 渲染速度要求快速，用户无明显等待感

**验收标准**:
- [ ] Mermaid 代码块被识别并转换为 SVG 图形
- [ ] 图形显示位置符合文档结构逻辑
- [ ] 图形清晰度满足阅读需求
- [ ] 渲染时间 < 3秒（单文件，10个图表以内）

#### 需求编号：REQ-003 表格渲染
**优先级**: P1 - 重要功能

**描述**:
- MD 文件中的表格语法必须正确渲染为 HTML 表格
- 表格格式整齐，列宽合理，内容对齐正确

**验收标准**:
- [ ] 表格语法被识别并转换为 HTML 表格
- [ ] 表格显示整齐，列宽自适应
- [ ] 中文内容正确显示

#### 需求编号：REQ-004 用户交互体验
**优先级**: P1 - 重要功能

**描述**:
- 文件选择操作简单直观
- 渲染过程有明确的状态反馈
- 错误信息清晰易懂

**验收标准**:
- [ ] 文件选择操作步骤 ≤ 3步
- [ ] 渲染过程有加载提示
- [ ] 错误信息描述明确，指导用户修复

### 2.2 非功能性需求

#### 性能需求
- **渲染速度**: 单文件（含10个图表）渲染时间 < 3秒
- **内存占用**: 单文件渲染内存 < 100MB
- **启动时间**: 冷启动 < 5秒

#### 兼容性需求
- **操作系统**: Windows 10/11
- **浏览器**: Chrome/Edge 最新版本
- **Mermaid版本**: v10.x 兼容性

#### 安全需求
- **输入验证**: 文件路径和内容必须验证
- **XSS防护**: 防止恶意脚本注入
- **文件安全**: 防止路径遍历攻击

---

## 三、技术架构

### 3.1 前端架构

- **框架**: 原生 JavaScript + HTML5
- **图表引擎**: Mermaid.js v10.9.5
- **Markdown 解析**: Marked.js v12.0.2
- **代码高亮**: highlight.js v10.7.2
- **运行环境**: 浏览器（Chrome/Edge）

> **注意**: 项目中存在 `src/components/`、`src/utils/` 下的 React/TypeScript 代码（App.tsx、index.tsx 等），但当前稳定版本使用原生 JavaScript 实现（app.html）。React/TypeScript 代码为早期探索遗留，暂未启用。

### 3.2 项目结构

```
MermaidReader/
├── app.html              # ✅ 主渲染程序（推荐使用）
├── browser_view.html           # 浏览器渲染工具
├── package.json                # 项目配置和依赖声明
├── package-lock.json           # 依赖版本锁定文件
│
├── src/                        # 源代码目录
│   ├── index.js                # 主逻辑文件（浏览器环境）
│   ├── browser_view.html       # 浏览器环境入口
│   ├── test-auto-render.js     # 自动化测试脚本
│   ├── App.css                 # 应用程序样式
│   ├── App.tsx                 # React 组件（早期探索，未启用）
│   ├── index.css               # 入口样式
│   ├── index.tsx               # React 入口（早期探索，未启用）
│   ├── types.ts                # TypeScript 类型定义（早期探索，未启用）
│   │
│   ├── components/             # React 组件目录（早期探索，未启用）
│   │   ├── ChartSettings.tsx   # 图表设置组件
│   │   ├── ChartSettings.css   # 图表设置样式
│   │   ├── FileExplorer.tsx    # 文件浏览器组件
│   │   ├── FileExplorer.css    # 文件浏览器样式
│   │   ├── MermaidRenderer.tsx # Mermaid渲染器组件
│   │   └── MermaidRenderer.css # Mermaid渲染器样式
│   │
│   ├── types/                  # 类型定义目录
│   │   └── chart-types.ts      # 图表类型定义
│   │
│   ├── utils/                  # 工具函数目录
│   │   ├── TableOptimizer.ts   # 表格优化工具
│   │   ├── fileSystem.ts       # 文件系统工具
│   │   └── flowchart-optimizer.ts # 流程图优化工具
│   │
│   └── test-results/           # 测试结果目录
│
├── node_modules/               # 依赖库目录
│   ├── mermaid/                # Mermaid.js 图表库
│   ├── marked/                 # Marked.js Markdown 解析库
│   ├── highlight.js/           # 代码语法高亮库
│   ├── puppeteer/              # Puppeteer 测试环境
│   └── (其他依赖)
│

│
├── release/                    # 发布版本目录
│   └── (打包输出)
│
├── tools/                      # 工具脚本目录
│   └── (辅助工具)
│
├── APP使用说明.md              # 使用说明文档
├── APP架构设计.md              # 本架构设计文档
├── APP和系统陪测代码管理规则.md # 代码管理规范
├── 调试笔记.md                 # 开发调试记录
├── 调试记录_backup.md          # 调试记录备份
│
└── MermaidReader-v1.0.zip      # 完整备份（包含 node_modules）
```

---

## 四、核心模块设计

### 4.1 主渲染程序 (app.html)

主渲染程序负责完整的 Markdown + Mermaid 渲染功能，是推荐的入口文件。

**核心逻辑**:
1. 加载本地依赖库（mermaid.min.js, marked.min.js, highlight.min.js）
2. 提供文件选择界面
3. 读取 MD 文件内容
4. 使用 marked.js 解析 Markdown
5. 使用 mermaid.run() 渲染 Mermaid 图表
6. 使用 highlight.js 高亮代码块
7. 渲染表格（自定义 CSS 样式）
8. 显示最终结果

### 4.2 Mermaid 渲染模块（app.html）

Mermaid 渲染逻辑集成在主渲染程序 app.html 中，是应用的核心模块，负责：

- **Mermaid 初始化**: 配置 Mermaid 图表引擎（v10.x API, mermaid.initialize）
- **代码清理**: 处理特殊字符（© → (c), — → ---, [['x']] → ["x"]）
- **图表提取**: 从 Markdown 内容中提取 Mermaid 代码块（正则 `/```mermaid\r?\n([\s\S]*?)```/g`）
- **异步渲染**: 将 Mermaid 代码转换为 SVG 图表（mermaid.run()）
- **Markdown 解析**: 使用 Marked.js 解析完整的 Markdown 内容
- **表格美化**: 使用自定义 CSS 样式优化表格显示
- **错误处理**: 提供优雅的错误处理和重试机制

> **注意**: `src/components/MermaidRenderer.tsx` 为早期 React 探索代码，未在当前版本使用。

### 4.3 文件系统模块

处理文件操作，包括：

- 文件选择对话框
- 文件内容读取
- 文件类型验证
- 文件大小验证
- XSS 防护
- 文件路径安全处理
- 错误处理和异常管理

### 4.4 表格优化模块

专门优化 Markdown 表格显示：

- 表格结构完整性检查
- 对齐方式优化
- 边框优化
- 单元格间距优化
- 问题检测与修复
- 性能优化

### 4.5 测试模块 (test-auto-render.js)

自动化测试脚本，功能：

- 扫描测试文件目录
- 对每个 MD 文件：
  - 复制到临时文件
  - 修复 Mermaid 语法问题
  - 使用 Puppeteer 渲染
  - 生成 SVG + HTML 输出
- 生成测试报告

**已修复的问题**:
- ©符号 → (c)
- 特殊破折号 → ---
- [['文本']] → ["文本"]
- 方括号内引号转义

---

## 五、渲染流程

### 5.1 完整渲染流程

```
用户操作
    │
    ▼
┌─────────────────┐
│  选择 MD 文件   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  读取文件内容   │ ← FileReader / fs.readFile
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  预处理文本     │ ← 修复 ©, —, [['x']]
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Marked 解析    │ ← marked.parse(content)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  代码高亮       │ ← highlight.js
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Mermaid 渲染   │ ← mermaid.run()
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  表格美化       │ ← CSS 样式
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  显示结果       │ ← innerHTML
└─────────────────┘
```

### 5.2 Mermaid 渲染细节

**代码块识别**:
```javascript
// 正则表达式
const mermaidBlock = /```mermaid\r?\n([\s\S]*?)```/g;
```

**渲染调用**:
```javascript
// Mermaid 10.x API
mermaid.run({
    querySelector: '.mermaid'
});
```

---

## 六、关键特性

### 6.1 特殊字符处理

app.html 中的渲染逻辑专门处理特殊字符，确保 Mermaid 图表正确解析：

- **版权符号**: `©` 和 `(C)` 自动转换为 `(c)`
- **破折号**: 特殊破折号（`—`、`–`）转换为 `---`
- **方括号语法**: `[['文本']]` 转换为 `["文本"]`
- **引号转义**: 方括号内未转义引号的处理
- **HTML标签**: `<br/>` 等保留，其他需要转义
- **中文字符**: 确保中文内容正确显示

### 6.2 表格优化

- 自动检测表格结构问题
- 优化列对齐方式
- 确保边框完整性
- 优化单元格间距
- 批量处理 Markdown 中的所有表格
- 表头浅蓝渐变背景，圆角和阴影

### 6.3 代码高亮

- 服务器端使用 highlight.js 处理
- marked.js 12.x 的 Renderer API 集成
- 关键字(红)、字符串(绿)、数字(蓝)、函数名(紫)

### 6.4 错误处理与恢复

- 优雅的错误提示
- 渲染失败时的重试机制
- 安全的文件内容处理
- 防止 XSS 攻击

---

## 七、集成方式

### 7.1 纯浏览器技术选型

#### 技术决策：选择 NW.js

**重要架构决策**：经过技术调研和实际测试，本项目选择 **NW.js** 作为桌面应用框架，**放弃 Tauri**。

#### 技术对比分析

| 对比维度 | NW.js (Chrome WebKit) | Tauri (Edge WebView) |
|----------|----------------------|---------------------|
| **渲染引擎** | Chrome WebKit | Edge WebView |
| **Mermaid 兼容性** | ✅ 完全兼容<br/>Mermaid.js 原生测试环境 | ❌ 存在兼容性风险<br/>渲染行为可能有差异 |
| **SVG 渲染** | ✅ 标准化 SVG 行为<br/>路径渲染稳定 | ⚠️ 可能存在细微差异 |
| **CSS 支持** | ✅ 完整 CSS Grid/Flexbox 支持 | ⚠️ 部分特性支持不完整 |
| **Web API** | ✅ 丰富的现代 Web API | ❌ 功能受限 |
| **应用体积** | ❌ 较大 (~100MB) | ✅ 较小 (~10MB) |
| **内存占用** | ❌ 较高 | ✅ 较低 |
| **性能** | ✅ JavaScript 性能最优 | ✅ 原生性能更好 |

#### 决策依据

1. **Mermaid 渲染兼容性优先**
   - Mermaid.js 主要在 Chrome 环境下开发和测试
   - SVG 渲染、CSS 样式在 Chrome 下最稳定
   - 避免跨浏览器渲染差异导致的显示问题

2. **复杂图表支持**
   - 本项目需要渲染包含中文、特殊字符的复杂流程图
   - Chrome WebKit 对复杂 SVG 和 CSS 的处理更可靠
   - 减少渲染失败和显示异常的风险

3. **开发一致性**
   - 开发、测试、生产环境统一使用 Chrome 引擎
   - 避免 "在我机器上能正常显示" 的问题

#### 放弃 Tauri 的原因

1. **Mermaid 渲染差异**
   - SVG 路径渲染差异
   - CSS Grid 布局不一致
   - JavaScript 性能特性差异

2. **复杂内容处理**
   - 中文字符渲染可能存在细微差异
   - HTML 标签处理行为不完全一致
   - CSS 动画和过渡效果可能不同

3. **项目需求匹配度**
   - 本项目核心需求：稳定的 Mermaid 图表渲染
   - Tauri 优势：体积小、性能高（非核心需求）
   - NW.js 优势：渲染兼容性（核心需求）

### 7.2 依赖管理策略

#### 版本锁定机制

**问题背景**:
- NW.js 内置 Chromium 自带 Mermaid（旧版本）
- npm 安装的是新版 (10.9.5)
- 两套版本混用导致渲染不一致

**解决方案**:
```
测试脚本 → Puppeteer(独立Chromium) → 本地 mermaid.min.js (v10.9.5)
```

**项目规范**:
1. **版本锁定**: `package.json` 中使用精确版本号而非 semver 范围
2. **统一渲染入口**: 所有环境统一使用本地文件
3. **禁止 CDN**: 确保所有环境都从本地加载，不依赖外部网络

### 7.3 浏览器兼容

- **Web 版本**: 使用 File API 进行文件操作
- **安全处理**: 安全的客户端文件处理
- **响应式**: 响应式界面设计
- **渐进增强**: 支持现代浏览器特性

---

## 八、便携版（Portable）

### 8.1 便携版概述

**便携版**是一个无需安装的 Windows 应用程序，可以直接解压后运行。

**特点**:
- 无需安装，双击即可运行
- 所有依赖打包在一起
- 可以放在 U 盘或任意目录运行
- 不修改系统注册表
- 完全离线可用

### 8.2 便携版目录结构

```
MermaidReader-portable/
├── nw.exe                    # NW.js 主程序
├── app.html                  # 应用界面
├── package.json              # 应用配置
├── src/                      # 源代码
├── node_modules/             # 依赖库
│   ├── mermaid/              # Mermaid.js
│   ├── marked/               # Marked.js
│   ├── highlight.js/         # highlight.js
│   └── (其他依赖)
├── locales/                  # 语言包（中文+英文）
│   ├── en-US.pak
│   ├── zh-CN.pak
│   └── zh-TW.pak
├── *.dll                     # Chromium 运行时
├── nw.pak                    # NW.js 资源包
└── ...
```

### 8.3 创建便携版

**步骤**:
1. 下载 NW.js v0.107.0（win-x64 版本）
2. 解压并删除不需要的 locales（只保留 en-US.pak、zh-CN.pak、zh-TW.pak）
3. 复制 app.html、package.json、src/、node_modules/ 到 NW.js 目录
4. 删除 test-results、swiftshader 等不需要的目录

**命令**:
```bash
# 解压 NW.js
unzip nwjs-v0.107.0-win-x64.zip

# 删除不需要的 locales
cd nwjs-v0.107.0-win-x64/locales
rm -f !(en-US.pak|zh-CN.pak|zh-TW.pak)

# 复制应用文件
cp ../../app.html .
cp ../../package.json .
cp -r ../../src .
cp -r ../../node_modules/mermaid ../../node_modules/marked ../../node_modules/highlight.js node_modules/

# 可选：删除不需要的目录
rm -rf swiftshark
```

### 8.4 运行便携版

**方式1：双击运行**
1. 打开 `MermaidReader-portable` 目录
2. 双击 `nw.exe`
3. 应用将启动

**方式2：命令行运行**
```bash
cd MermaidReader-portable
nw.exe
```

### 8.5 便携版体积

| 项目 | 大小 |
|------|------|
| 完整版（含所有 locales） | ~430MB |
| 精简版（只保留中文+英文） | ~377MB |
| 核心文件（不含测试结果） | ~377MB |

> **注意**: 便携版体积较大是因为 NW.js 内置了完整的 Chromium 浏览器引擎，这是其渲染兼容性的代价。

---

## 九、集成方式

### 9.1 桌面应用技术选型

#### 技术决策：选择 NW.js

**重要架构决策**：经过技术调研和实际测试，本项目选择 **NW.js** 作为桌面应用框架，**放弃 Tauri**。

#### 技术对比分析

| 对比维度 | NW.js (Chrome WebKit) | Tauri (Edge WebView) |
|----------|----------------------|---------------------|
| **渲染引擎** | Chrome WebKit | Edge WebView |
| **Mermaid 兼容性** | ✅ 完全兼容<br/>Mermaid.js 原生测试环境 | ❌ 存在兼容性风险<br/>渲染行为可能有差异 |
| **SVG 渲染** | ✅ 标准化 SVG 行为<br/>路径渲染稳定 | ⚠️ 可能存在细微差异 |
| **CSS 支持** | ✅ 完整 CSS Grid/Flexbox 支持 | ⚠️ 部分特性支持不完整 |
| **Web API** | ✅ 丰富的现代 Web API | ❌ 功能受限 |
| **应用体积** | ❌ 较大 (~100MB) | ✅ 较小 (~10MB) |
| **内存占用** | ❌ 较高 | ✅ 较低 |
| **性能** | ✅ JavaScript 性能最优 | ✅ 原生性能更好 |

#### 决策依据

1. **Mermaid 渲染兼容性优先**
   - Mermaid.js 主要在 Chrome 环境下开发和测试
   - SVG 渲染、CSS 样式在 Chrome 下最稳定
   - 避免跨浏览器渲染差异导致的显示问题

2. **复杂图表支持**
   - 本项目需要渲染包含中文、特殊字符的复杂流程图
   - Chrome WebKit 对复杂 SVG 和 CSS 的处理更可靠
   - 减少渲染失败和显示异常的风险

3. **开发一致性**
   - 开发、测试、生产环境统一使用 Chrome 引擎
   - 避免 "在我机器上能正常显示" 的问题

#### 放弃 Tauri 的原因

1. **Mermaid 渲染差异**
   - SVG 路径渲染差异
   - CSS Grid 布局不一致
   - JavaScript 性能特性差异

2. **复杂内容处理**
   - 中文字符渲染可能存在细微差异
   - HTML 标签处理行为不完全一致
   - CSS 动画和过渡效果可能不同

3. **项目需求匹配度**
   - 本项目核心需求：稳定的 Mermaid 图表渲染
   - Tauri 优势：体积小、性能高（非核心需求）
   - NW.js 优势：渲染兼容性（核心需求）

### 9.2 依赖管理策略

#### 版本锁定机制

**问题背景**:
- NW.js 内置 Chromium 自带 Mermaid（旧版本）
- npm 安装的是新版 (10.9.5)
- 两套版本混用导致渲染不一致

**解决方案**:
```
测试脚本 → Puppeteer(独立Chromium) → 本地 mermaid.min.js (v10.9.5)
```

**项目规范**:
1. **版本锁定**: `package.json` 中使用精确版本号而非 semver 范围
2. **统一渲染入口**: 所有环境统一使用本地文件
3. **禁止 CDN**: 确保所有环境都从本地加载，不依赖外部网络

### 9.3 浏览器兼容

- **Web 版本**: 使用 File API 进行文件操作
- **安全处理**: 安全的客户端文件处理
- **响应式**: 响应式界面设计
- **渐进增强**: 支持现代浏览器特性

---

## 十、扩展性考虑

- 模块化设计便于功能扩展
- 可配置的 Mermaid 渲染选项
- 可扩展的表格优化规则
- 插件化架构支持

---

## 十一、安全性

- 文件路径安全验证
- XSS 防护机制
- 内容安全过滤
- 文件大小限制
- 安全的文件读取机制

---

## 十二、性能优化

- 异步渲染避免界面阻塞
- 代码块懒加载
- 内存管理优化
- 渲染缓存机制
- 事件委托优化
- 换行符兼容处理（`\r?\n`）

---

## 十三、配置文件

### 13.1 package.json

- 应用名称、版本、描述
- NW.js 窗口配置（宽高、位置、可调整大小等）
- 应用图标配置
- 依赖版本声明

### 13.2 依赖版本

| 库名 | 版本 | 用途 |
|------|------|------|
| mermaid | 10.9.5 | Mermaid 图表渲染 |
| marked | 12.0.2 | Markdown 解析 |
| highlight.js | 10.7.2 | 代码语法高亮 |
| puppeteer | 23.8.0 | 自动化测试 |

### 13.3 样式文件

- app.html 内嵌 CSS
- App.css: 全局样式定义

---

## 十四、方法论反思与优化

### 14.1 问题回顾

在 2026-01-29 至 2026-01-30 期间，项目团队在解决 Mermaid 渲染问题上遇到了显著困难：

#### 遇到的主要问题
1. **Mermaid 图表完全不显示** - 核心渲染功能失效
2. **版本混乱** - NW.js 内置版本与 node_modules 版本不一致
3. **语法解析错误** - `Divider1[---]` 等特殊字符被误解析
4. **特殊字符问题** - `©`、`<br/>`、中文引号等导致解析失败

#### 尝试的解决方案（未成功）
1. 使用 CDN 版本的 Mermaid - 失败（版本不匹配）
2. 修改 MD 文件内容 - 临时方案，不可持续
3. 复杂的正则表达式修复 - 增加了维护成本
4. 外部渲染管线 - 绕过了 reader 源码修改的核心要求

### 14.2 问题根因分析

#### 方法论层面的问题

##### 问题1: 目标不清晰
- **表现**: 在"修改 reader 源码"和"外部包装方案"之间反复摇摆
- **根因**: 没有明确界定"什么才算成功"
- **影响**: 浪费了大量时间在非核心路径上

**优化方案**:
- 明确定义成功标准（需求文档化）
- 建立清晰的验收标准
- 设定阶段性里程碑

##### 问题2: 验证回路过长
- **表现**: 修改代码后需要完整打包、部署才能测试
- **根因**: 缺少快速验证机制
- **影响**: 定位问题效率极低

**优化方案**:
- 建立浏览器端快速验证入口（browser_view.html）
- 实现单元测试覆盖核心渲染逻辑
- 缩短"修改-验证"循环

##### 问题3: 范围蔓延
- **表现**: 不断添加新功能（PNG 转换、仪表盘、批量处理）
- **根因**: 没有严格控制需求范围
- **影响**: 核心问题迟迟未解决

**优化方案**:
- 坚持"最小可行产品"原则
- 核心功能（P0）未完成前不添加新功能
- 建立需求变更控制流程

##### 问题4: 技术债务累积
- **表现**: 存在多个版本的实现（scripts/、MermaidReader/、根目录）
- **根因**: 缺少统一的架构约束
- **影响**: 维护成本增加，一致性差

**优化方案**:
- 确立 MermaidReader 作为唯一核心实现位置
- 清理废弃代码和重复实现
- 建立代码审查机制

### 14.3 优化后的方法论

#### 需求驱动开发

**原则**: 先定义需求，再设计实现

**流程**:
1. 需求定义
2. 验收标准制定
3. 实现方案设计
4. 代码实现
5. 自动化验证
6. 手动验收

#### 快速验证循环

**原则**: 缩短从代码修改到验证结果的时间

**实现**:
1. **浏览器端验证入口**: browser_view.html
2. **单元测试覆盖**: 核心渲染函数独立测试
3. **持续集成**: 提交即测试，失败即通知

#### 范围控制

**原则**: 核心功能未完成前不添加新功能

**实施**:
1. **功能分级**:
   - P0: 核心功能（文件读取、Mermaid渲染、表格渲染）
   - P1: 重要功能（错误提示、性能优化）
   - P2: 增强功能（主题切换、导出功能）

2. **需求变更控制**:
   - 任何新需求必须经过评审
   - 必须有明确的 P0 功能完成证明
   - 记录变更原因和影响分析

#### 单一职责原则

**原则**: 每个模块只做一件事

**实施**:
1. **模块划分**:
   - app.html: 主渲染程序
   - browser_view.html: 浏览器端演示
   - test-auto-render.js: 自动化测试

2. **依赖管理**:
   - 所有依赖通过 package.json 管理
   - 禁止使用 CDN
   - 版本锁定

### 14.4 技术债务跟踪

#### 已知问题
1. **性能**: 大型文档渲染可能较慢
2. **内存**: 多图表同时渲染内存占用高
3. **兼容性**: 某些极端 Mermaid 语法可能不支持

#### 改进计划
1. **v1.0**: 实现核心渲染功能，完成浏览器端验证
2. **v1.1**: 性能优化，添加渲染缓存
3. **v1.2**: 错误处理完善，用户体验提升
4. **v2.0**: 考虑自研轻量渲染器

---

## 十五、版本信息

### 当前版本
- **版本号**: 1.0
- **发布日期**: 2026-01-30
- **状态**: 正式发布

### 版本历史
| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0 | 2026-01-30 | 初始版本发布，包含核心功能 |
|      |            | - 文件读取与显示 |
|      |            | - Mermaid 图表渲染 |
|      |            | - 表格渲染 |
|      |            | - 代码语法高亮 |
|      |            | - 自动化测试脚本 |

---

## 附录

### A. 术语表
- **Reader**: MermaidReader 的简称
- **Mermaid**: 图表渲染库
- **Marked**: Markdown 解析库
- **highlight.js**: 代码语法高亮库
- **NW.js**: 桌面应用框架
- **Puppeteer**: 自动化测试工具

### B. 参考文档
- Mermaid 官方文档: https://mermaid.js.org/
- Marked 官方文档: https://marked.js.org/
- NW.js 官方文档: https://nwjs.io/
- highlight.js 官方文档: https://highlightjs.org/

### C. 快速启动

#### 方式一：便携版（推荐）

1. 下载并解压 `MermaidReader-portable.zip`
2. 双击 `nw.exe` 即可运行

#### 方式二：浏览器环境启动

直接在浏览器中打开 `browser_view.html` 文件即可运行应用。

#### 运行测试
```bash
node src/test-auto-render.js
```

### D. 备份与恢复

#### 完整备份
备份文件: `MermaidReader-v1.0.zip`

**包含内容**:
- 完整项目目录
- node_modules（所有依赖）

**恢复方法**:
```bash
# 解压到新位置
unzip MermaidReader-v1.0.zip

# 进入目录
cd MermaidReader
```

#### 手动备份建议
```bash
zip -r MermaidReader-backup.zip . \
    -x "node_modules/*" \
    -x "src/test-results/*" \
    -x "*.log"
```

#### 便携版打包

**便携版**是一个无需安装的 Windows 应用程序，目录结构如下：

```
MermaidReader-portable/
├── nw.exe                    # NW.js 主程序
├── app.html                  # 应用界面
├── package.json              # 应用配置
├── src/                      # 源代码
├── node_modules/             # 依赖库
├── locales/                  # 语言包（中文+英文）
├── *.dll                     # Chromium 运行时
├── nw.pak                    # NW.js 资源包
└── ...
```

**打包步骤**:
1. 下载 NW.js v0.107.0（win-x64）
2. 解压并精简 locales（只保留 en-US.pak、zh-CN.pak、zh-TW.pak）
3. 复制 app.html、package.json、src/、node_modules/
4. 删除 swiftshader、test-results 等不需要的目录

**体积**:
- 完整版：~430MB
- 精简版：~377MB

### E. 扩展开发指南

#### 添加新功能
1. 在 `app.html` 中添加功能代码
2. 在 `src/index.js` 中添加对应逻辑（如需要）
3. 更新 `APP使用说明.md`
4. 运行测试脚本验证

#### 修改样式
样式定义在 app.html 的 `<style>` 标签内。

#### 升级依赖
```bash
# 安装新版本
npm install mermaid@<新版本号>

# 运行测试
node src/test-auto-render.js

# 检查输出
cat src/test-results/report.txt

# 更新文档
# 1. 更新 package.json 版本号
# 2. 更新本文档第十一章
```

---

## 十二、方法论反思与优化

### 12.1 问题回顾

在 2026-01-29 至 2026-01-30 期间，项目团队在解决 Mermaid 渲染问题上遇到了显著困难：

#### 遇到的主要问题
1. **Mermaid 图表完全不显示** - 核心渲染功能失效
2. **版本混乱** - NW.js 内置版本与 node_modules 版本不一致
3. **语法解析错误** - `Divider1[---]` 等特殊字符被误解析
4. **特殊字符问题** - `©`、`<br/>`、中文引号等导致解析失败

#### 尝试的解决方案（未成功）
1. 使用 CDN 版本的 Mermaid - 失败（版本不匹配）
2. 修改 MD 文件内容 - 临时方案，不可持续
3. 复杂的正则表达式修复 - 增加了维护成本
4. 外部渲染管线 - 绕过了 reader 源码修改的核心要求

### 12.2 问题根因分析

#### 方法论层面的问题

##### 问题1: 目标不清晰
- **表现**: 在"修改 reader 源码"和"外部包装方案"之间反复摇摆
- **根因**: 没有明确界定"什么才算成功"
- **影响**: 浪费了大量时间在非核心路径上

**优化方案**:
- 明确定义成功标准（需求文档化）
- 建立清晰的验收标准
- 设定阶段性里程碑

##### 问题2: 验证回路过长
- **表现**: 修改代码后需要完整打包、部署才能测试
- **根因**: 缺少快速验证机制
- **影响**: 定位问题效率极低

**优化方案**:
- 建立浏览器端快速验证入口（browser_view.html）
- 实现单元测试覆盖核心渲染逻辑
- 缩短"修改-验证"循环

##### 问题3: 范围蔓延
- **表现**: 不断添加新功能（PNG 转换、仪表盘、批量处理）
- **根因**: 没有严格控制需求范围
- **影响**: 核心问题迟迟未解决

**优化方案**:
- 坚持"最小可行产品"原则
- 核心功能（P0）未完成前不添加新功能
- 建立需求变更控制流程

##### 问题4: 技术债务累积
- **表现**: 存在多个版本的实现（scripts/、MermaidReader/、根目录）
- **根因**: 缺少统一的架构约束
- **影响**: 维护成本增加，一致性差

**优化方案**:
- 确立 MermaidReader 作为唯一核心实现位置
- 清理废弃代码和重复实现
- 建立代码审查机制

### 12.3 优化后的方法论

#### 需求驱动开发

**原则**: 先定义需求，再设计实现

**流程**:
1. 需求定义
2. 验收标准制定
3. 实现方案设计
4. 代码实现
5. 自动化验证
6. 手动验收

#### 快速验证循环

**原则**: 缩短从代码修改到验证结果的时间

**实现**:
1. **浏览器端验证入口**: browser_view.html
2. **单元测试覆盖**: 核心渲染函数独立测试
3. **持续集成**: 提交即测试，失败即通知

#### 范围控制

**原则**: 核心功能未完成前不添加新功能

**实施**:
1. **功能分级**:
   - P0: 核心功能（文件读取、Mermaid渲染、表格渲染）
   - P1: 重要功能（错误提示、性能优化）
   - P2: 增强功能（主题切换、导出功能）

2. **需求变更控制**:
   - 任何新需求必须经过评审
   - 必须有明确的 P0 功能完成证明
   - 记录变更原因和影响分析

#### 单一职责原则

**原则**: 每个模块只做一件事

**实施**:
1. **模块划分**:
   - app.html: 主渲染程序
   - browser_view.html: 浏览器端演示
   - test-auto-render.js: 自动化测试

2. **依赖管理**:
   - 所有依赖通过 package.json 管理
   - 禁止使用 CDN
   - 版本锁定

### 12.4 技术债务跟踪

#### 已知问题
1. **性能**: 大型文档渲染可能较慢
2. **内存**: 多图表同时渲染内存占用高
3. **兼容性**: 某些极端 Mermaid 语法可能不支持

#### 改进计划
1. **v1.0**: 实现核心渲染功能，完成浏览器端验证
2. **v1.1**: 性能优化，添加渲染缓存
3. **v1.2**: 错误处理完善，用户体验提升
4. **v2.0**: 考虑自研轻量渲染器

---

## 十三、版本信息

### 当前版本
- **版本号**: 1.0
- **发布日期**: 2026-01-30
- **状态**: 正式发布

### 版本历史
| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0 | 2026-01-30 | 初始版本发布，包含核心功能 |
|      |            | - 文件读取与显示 |
|      |            | - Mermaid 图表渲染 |
|      |            | - 表格渲染 |
|      |            | - 代码语法高亮 |
|      |            | - 自动化测试脚本 |

---

## 附录

### A. 术语表
- **Reader**: MermaidReader 的简称
- **Mermaid**: 图表渲染库
- **Marked**: Markdown 解析库
- **highlight.js**: 代码语法高亮库
- **NW.js**: 桌面应用框架
- **Puppeteer**: 自动化测试工具

### B. 参考文档
- Mermaid 官方文档: https://mermaid.js.org/
- Marked 官方文档: https://marked.js.org/
- NW.js 官方文档: https://nwjs.io/
- highlight.js 官方文档: https://highlightjs.org/

### C. 快速启动

#### 方式一：便携版（推荐）

1. 下载并解压 `MermaidReader-portable.zip`
2. 双击 `nw.exe` 即可运行

#### 方式二：浏览器环境启动

直接在浏览器中打开 `browser_view.html` 文件即可运行应用。

#### 运行测试
```bash
node src/test-auto-render.js
```

### D. 备份与恢复

#### 完整备份
备份文件: `MermaidReader-v1.0.zip`

**包含内容**:
- 完整项目目录
- node_modules（所有依赖）

**恢复方法**:
```bash
# 解压到新位置
unzip MermaidReader-v1.0.zip

# 进入目录
cd MermaidReader
```

#### 手动备份建议
```bash
zip -r MermaidReader-backup.zip . \
    -x "node_modules/*" \
    -x "src/test-results/*" \
    -x "*.log"
```

#### 便携版打包

**便携版**是一个无需安装的 Windows 应用程序，目录结构如下：

```
MermaidReader-portable/
├── nw.exe                    # NW.js 主程序
├── app.html                  # 应用界面
├── package.json              # 应用配置
├── src/                      # 源代码
├── node_modules/             # 依赖库
├── locales/                  # 语言包（中文+英文）
├── *.dll                     # Chromium 运行时
├── nw.pak                    # NW.js 资源包
└── ...
```

**打包步骤**:
1. 下载 NW.js v0.107.0（win-x64）
2. 解压并精简 locales（只保留 en-US.pak、zh-CN.pak、zh-TW.pak）
3. 复制 app.html、package.json、src/、node_modules/
4. 删除 swiftshader、test-results 等不需要的目录

**体积**:
- 完整版：~430MB
- 精简版：~377MB

### E. 扩展开发指南

#### 添加新功能
1. 在 `app.html` 中添加功能代码
2. 在 `src/index.js` 中添加对应逻辑（如需要）
3. 更新 `APP使用说明.md`
4. 运行测试脚本验证

#### 修改样式
样式定义在 app.html 的 `<style>` 标签内。

#### 升级依赖
```bash
# 安装新版本
npm install mermaid@<新版本号>

# 运行测试
node src/test-auto-render.js

# 检查输出
cat src/test-results/report.txt

# 更新文档
# 1. 更新 package.json 版本号
# 2. 更新本文档第十一章
```
