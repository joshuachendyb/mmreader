# MermaidReader 调试笔记 - Go+WebView2 桌面应用打包

## **创建时间**: 2026-01-31 16:35:00

---

## 环境配置与依赖安装

### 1. 初始化Go模块
```bash
cd D:\2bktest\MDview\MermaidReader\gobuild
go mod init MermaidReader
```
- **用途**: 创建Go模块文件，管理依赖关系
- **结果**: 生成go.mod文件

### 2. 设置中国代理
```bash
go env -w GOPROXY=https://goproxy.cn,direct
```
- **用途**: 解决国内网络无法访问golang.org的问题
- **结果**: 能够正常下载Go依赖包

### 3. 安装Lorca依赖
```bash
go get github.com/zserge/lorca@latest
```
- **用途**: 提供桌面窗口功能，基于系统WebView
- **结果**: 下载并安装Lorca库，用于创建桌面应用窗口

### 4. 安装Wails CLI
```bash
go install github.com/wailsapp/wails/v2/cmd/wails@latest
```
- **用途**: Wails命令行工具，用于构建桌面应用
- **结果**: 安装wails命令到~/go/bin目录

### 5. 安装Wails依赖
```bash
go get github.com/wailsapp/wails/v2@latest
```
- **用途**: Wails核心库，提供Go+WebView2集成
- **结果**: 下载Wails v2.11.0及其所有依赖

---

## 打包过程与命令

### 基础构建命令
```bash
go build -o bin/MermaidReader.exe main-simple.go
```
- **用途**: 编译简单的HTTP服务器+浏览器版本
- **结果**: 生成9.4MB的可执行文件

### Wails构建命令
```bash
~/go/bin/wails build
```
- **用途**: 使用Wails构建真正的桌面应用
- **结果**: 生成10.4MB的桌面应用exe文件
- **输出位置**: `build/bin/MermaidReader.exe`

### 文件复制命令
```bash
cp build/bin/MermaidReader.exe bin/MermaidReader.exe
```
- **用途**: 将构建结果复制到bin目录便于访问
- **结果**: 更新bin目录下的可执行文件

---

## 问题排查与解决过程

### 问题1: 端口冲突问题
**现象**: 
```
HTTP服务器启动在 http://localhost:8080
服务器错误: listen tcp :8080: bind: Only one usage of each socket address
```
**原因**: 8080端口被其他进程占用
**解决方案**: 
1. 修改main-lorca.go中的端口设置：`port = 8080` → `port = 8090`
2. 重新编译应用
**结果**: 解决端口冲突，应用正常启动

### 问题2: Lorca WebSocket连接失败
**现象**: 
```
创建UI失败: websocket.Dial ws://127.0.0.1:53752/devtools/browser/...: bad status
```
**原因**: Lorca的DevTools连接机制不稳定
**解决方案**: 
1. 切换到Wails框架，提供更稳定的WebView2集成
2. 使用go install安装wails CLI
3. 重写应用结构使用Wails标准模式
**结果**: 解决窗口创建失败问题

### 问题3: 静态资源路径错误
**现象**: 应用窗口黑色，显示隐约字符
**原因**: Wails中静态资源路径不应该包含/static前缀
**解决方案**: 
1. 修改index.html中的资源引用：
   - `/static/css/mermaid.css` → `css/mermaid.css`
   - `/static/css/style.css` → `css/style.css`
   - `/static/js/mermaid.min.js` → `js/mermaid.min.js`
   - `/static/js/app.js` → `js/app.js`
2. 修改API调用：`/api/version` → `api/version`
**结果**: CSS和JavaScript正确加载，界面正常显示

### 问题4: JavaScript代码显示在页面底部
**现象**: 界面底部显示大量JavaScript代码文本
**原因**: HTML文件中存在重复的`</script>`标签
**解决方案**: 
1. 检查index.html结构，移除重复的script闭合标签
2. 确保script标签正确嵌套
**结果**: 修复HTML结构，JavaScript不再显示在界面上

### 问题5: 按钮无法点击问题
**现象**: 所有按钮都无法响应点击事件
**原因**: JavaScript函数重复定义和事件绑定错误
**解决方案**: 
1. 重写完整的JavaScript代码，确保函数定义唯一
2. 重新绑定所有事件监听器
3. 确保DOM元素正确获取和绑定
**结果**: 按钮恢复正常功能

### 问题6: 界面布局不符合需求
**用户需求**: 
1. 左侧文件操作区域合并
2. 右侧预览窗口不分割
3. 所有按钮在一行排列
**解决方案**: 
1. 简化左侧sidebar结构，只保留文件操作和最近文件
2. 右侧使用单一预览区域，不再上下分割
3. 在预览头部添加所有按钮，使用flex布局自动换行
4. 调整CSS样式：`flex-wrap: wrap`支持按钮换行
**结果**: 界面布局符合用户要求

---

## 技术栈总结

### 核心技术
- **Go 1.25.6**: 后端编程语言
- **Wails v2.11.0**: Go+WebView2桌面应用框架
- **WebView2**: Windows系统内置的WebView控件
- **HTML5/CSS3/JavaScript**: 前端技术栈
- **Mermaid.js**: 图表渲染库

### 依赖库清单
- `github.com/wailsapp/wails/v2`: 桌面应用框架
- `github.com/wailsapp/go-webview2`: WebView2 Go绑定
- 其他Wails相关依赖包（约50个包）

---

## 最终产物

### 可执行文件
- **路径**: `D:\2bktest\MDview\MermaidReader\gobuild\bin\MermaidReader.exe`
- **大小**: 10,388,480 字节 (约10.4MB)
- **类型**: Windows桌面应用
- **架构**: amd64

### 功能特性
✅ 桌面窗口界面  
✅ 文件打开和管理  
✅ Mermaid图表实时预览  
✅ 主题切换（浅色/深色）  
✅ 字体大小调节  
✅ 最近文件列表  
✅ 导出Word和PDF（框架）  

---

## 构建总结

本次打包过程经历了多次技术方案调整：
1. **Lorca方案** → **Wails方案**：解决WebView集成稳定性问题
2. **端口8080** → **端口8090**：解决端口冲突
3. **多窗口布局** → **单窗口布局**：符合用户界面需求
4. **路径修复** → **事件修复** → **布局优化**：逐步完善用户体验

最终成功产出可用的桌面应用程序，实现了核心的Mermaid图表编辑和预览功能。