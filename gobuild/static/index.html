<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Reader</title>
    
    <!-- å¼•å…¥æœ¬åœ°åº“ -->
    <script src="js/mermaid.min.js"></script>
    <script src="js/marked.min.js"></script>
    <script src="js/highlight.min.js"></script>
    <!-- Highlight.js é»˜è®¤æ ·å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" integrity="sha512-hasInXwXxC7bPM/2rC8O8+rwP1oK88S/8X0jP6Rz8B8z5v5A9x4u6z5v5A9x4u6z5v5A9x4u6z5v5A9x4u6z5v5A9" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        :root {
            /* äº®è‰²ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰- æ·±è“ç°ä¸“ä¸šé£ */
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8eaed;
            --text-primary: #2c3e50;
            --text-secondary: #34495e;
            --text-muted: #7f8c8d;
            --border-color: #d5d8dc;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --toolbar-bg: #2c3e50;
            --code-bg: #f4f6f7;
            --shadow-color: rgba(0,0,0,0.12);
            --error-bg: #fdf2f2;
            --error-border: #fecaca;
            --error-text: #dc2626;
            --success-bg: #f0fdf4;
            --success-border: #bbf7d0;
            --success-text: #16a34a;
            --warning-bg: #fffbeb;
            --warning-border: #fde68a;
            --warning-text: #d97706;
            --info-bg: #eff6ff;
            --info-border: #bfdbfe;
            --info-text: #2563eb;
            --table-header-bg: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
            --table-header-text: #ecf0f1;
            --table-hover: #f8f9fa;
            --table-stripe: #f1f3f4;
            --toc-hover: #e3f2fd;
            --toc-active: #bbdefb;
            --toc-hover-text: #1976d2;
            --toc-active-text: #1565c0;
        }

        [data-theme="dark"] {
            /* æ·±è‰²ä¸»é¢˜ - æ·±è“ç°ä¸“ä¸šé£ */
            --bg-primary: #1e272e;
            --bg-secondary: #2d3436;
            --bg-tertiary: #252b2d;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-muted: #95a5a6;
            --border-color: #34495e;
            --accent-color: #74b9ff;
            --accent-hover: #5aa3e8;
            --toolbar-bg: #2c3e50;
            --code-bg: #2d3436;
            --shadow-color: rgba(0,0,0,0.4);
            --error-bg: #3d1f1f;
            --error-border: #5c2b2b;
            --error-text: #ff6b6b;
            --success-bg: #1e3a2f;
            --success-border: #2d5a3d;
            --success-text: #6dd55a;
            --warning-bg: #3d3118;
            --warning-border: #5c4a28;
            --warning-text: #ffc107;
            --info-bg: #1a2f4a;
            --info-border: #2a4a6e;
            --info-text: #74b9ff;
            --table-header-bg: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
            --table-header-text: #ecf0f1;
            --table-hover: #2d3436;
            --table-stripe: #252b2d;
            --toc-hover: #1e3a5a;
            --toc-active: #2a4a6e;
            --toc-hover-text: #74b9ff;
            --toc-active-text: #90caf9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .toolbar {
            background: var(--toolbar-bg);
            color: white;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            height: 56px;
            flex-shrink: 0;
        }

        .toolbar h1 {
            font-size: 1.25rem;
            margin-right: 20px;
        }

        .btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
            color: white;
            border: 1px solid rgba(255,255,255,0.25);
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.25s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .btn-icon {
            padding: 6px 10px;
            min-width: 32px;
            justify-content: center;
        }

        #font-size-display {
            color: white;
            font-size: 13px;
            min-width: 40px;
            text-align: center;
        }

        #status {
            font-size: 14px;
            margin-left: auto;
        }

        /* å·¥å…·æ æ–‡ä»¶åå±…ä¸­æ˜¾ç¤º */
        .toolbar-filename {
            max-width: 500px;
            text-align: center;
            color: white;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }

        .toolbar-filename .filename-label {
            color: rgba(255,255,255,0.7);
            margin-right: 5px;
        }

        .content {
            display: flex;
            height: calc(100vh - 56px);
        }

        .sidebar {
            width: 280px;
            min-width: 280px;
            border-right: 1px solid var(--border-color);
            overflow: hidden;
            padding: 15px;
            background: var(--bg-tertiary);
            transition: background-color 0.3s, border-color 0.3s;
            display: flex;
            flex-direction: column;
        }

        .sidebar h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--text-secondary);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent-color);
            transition: color 0.3s;
        }

        .preview {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background: var(--bg-primary);
            transition: background-color 0.3s, font-size 0.3s;
        }

        .mermaid-container {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .text-content {
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
            box-shadow: 0 1px 3px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .text-content h1, 
        .text-content h2, 
        .text-content h3, 
        .text-content h4,
        .text-content h5,
        .text-content h6 {
            color: var(--text-primary);
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
            transition: color 0.3s, border-color 0.3s;
        }

        .text-content h2 { font-size: 1.6em; border-bottom-color: var(--border-color); }
        .text-content h3 { font-size: 1.3em; color: var(--accent-color); }
        .text-content p {
            line-height: 1.8;
            margin-bottom: 10px;
            color: var(--text-secondary);
            text-align: justify;
            transition: color 0.3s;
        }

        .text-content ul, .text-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .text-content li {
            margin-bottom: 5px;
            line-height: 1.5;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .text-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        .text-content pre {
            background: var(--code-bg);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .text-content pre code {
            background: transparent;
            padding: 0;
            border: none;
            color: inherit;
            font-size: 0.85em;
            line-height: 1.6;
        }

        .text-content strong {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s;
        }

        .text-content hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 24px 0;
            transition: border-color 0.3s;
        }

        .text-content blockquote {
            margin: 16px 0;
            padding: 12px 16px;
            border-left: 4px solid var(--accent-color);
            background: var(--info-bg);
            color: var(--info-text);
            border-radius: 0 4px 4px 0;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            border-collapse: collapse;
            margin: 20px 0;
            width: 100%;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        table th, table td {
            padding: 7px 18px;
            text-align: left;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            transition: color 0.3s, border-color 0.3s;
        }

        table th {
            background: var(--table-header-bg);
            color: var(--table-header-text);
            font-weight: 600;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        table tbody tr:hover {
            background: var(--table-hover);
            transition: background-color 0.3s;
        }

        table tbody tr:nth-child(even) {
            background: var(--table-stripe);
            transition: background-color 0.3s;
        }

        /* ç›®å½•æ ·å¼ */
        #toc-container {
            padding: 5px;
        }

        #toc-container .toc-item {
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding: 6px 10px;
            margin: 2px 0;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            border-radius: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }

        #toc-container .toc-item:hover {
            background: var(--toc-hover);
            color: var(--toc-hover-text);
            border-color: var(--accent-color);
        }

        #toc-container .toc-item.active {
            background: var(--toc-active);
            color: var(--toc-active-text);
            border-color: var(--accent-color);
        }

        .toc-empty {
            color: var(--text-muted);
            font-size: 12px;
            padding: 10px;
        }

        /* æ¬¢è¿é¡µé¢æ ·å¼ */
        .welcome {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .welcome h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .welcome p {
            margin: 10px 0;
            color: var(--text-muted);
        }

        .welcome #load-status {
            margin-top: 40px;
            padding: 15px 25px;
            background: var(--info-bg);
            border-radius: 8px;
            display: inline-block;
            color: var(--info-text);
        }

        /* æ¶ˆæ¯æç¤ºæ ·å¼ */
        .error { 
            background: var(--error-bg); 
            border: 1px solid var(--error-border); 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            color: var(--error-text); 
        }

        .success-message {
            background: var(--success-bg);
            border: 1px solid var(--success-border);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            color: var(--success-text);
        }

        .warning-message {
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            color: var(--warning-text);
        }

        /* æ–‡ä»¶æ ‡é¢˜æ ·å¼ */
        #preview h2[id^="file-title"] {
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            transition: color 0.3s, border-color 0.3s;
        }

        /* æœ€è¿‘æ–‡ä»¶åˆ—è¡¨ */
        .recent-file-item {
            padding: 8px 10px;
            margin: 4px 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-file-item:hover {
            background: var(--toc-hover);
            border-color: var(--accent-color);
            color: var(--toc-hover-text);
        }

        /* Tabåˆ‡æ¢æ ·å¼ - å›ºå®šåœ¨é¡¶éƒ¨ */
        .sidebar-tabs {
            display: flex;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border-bottom: 2px solid transparent;
        }

        .sidebar-tab:hover {
            color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
        }

        .sidebar-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: rgba(52,152,219,0.08);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }

        .sidebar-section {
            display: none;
        }

        .sidebar-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar { width: 200px; min-width: 200px; }
            .preview { font-size: 12px; padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>Mermaid Reader <span id="app-version" style="font-size: 0.7em; color: rgba(255,255,255,0.7);">v1.4</span></h1>
        <button class="btn" onclick="openFile()">æ‰“å¼€æ–‡ä»¶</button>
        <button class="btn" onclick="clearContent()">æ¸…ç©º</button>
        <div style="flex: 1;"></div>
        
        <!-- æ–‡ä»¶åå±…ä¸­æ˜¾ç¤º -->
        <div class="toolbar-filename">
            <span id="filename-display"></span>
        </div>
        
        <div style="flex: 1;"></div>
        
        <button class="btn btn-icon" onclick="adjustFontSize(-1)" title="ç¼©å°å­—ä½“">A-</button>
        <span id="font-size-display">100%</span>
        <button class="btn btn-icon" onclick="adjustFontSize(1)" title="æ”¾å¤§å­—ä½“">A+</button>
        
        <button class="btn" id="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">ğŸŒ™</span> æ·±è‰²æ¨¡å¼
        </button>
        
        <button class="btn" onclick="exportWord()" title="å¯¼å‡ºWord">ğŸ“„ Word</button>
        <button class="btn" onclick="exportPDF()" title="å¯¼å‡ºPDF">ğŸ“‹ PDF</button>
        <button class="btn" id="source-toggle" onclick="toggleSourceView()" title="åˆ‡æ¢æºç /é¢„è§ˆ">ğŸ“„ æºç </button>
    </div>
    
    <div class="content">
        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchSidebarTab('toc')" id="tab-toc">ç›®å½•</button>
                <button class="sidebar-tab" onclick="switchSidebarTab('files')" id="tab-files">æœ€è¿‘æ–‡ä»¶</button>
            </div>
            <div class="sidebar-content">
                <div id="section-toc" class="sidebar-section active">
                    <div id="toc-container">
                        <p class="toc-empty">æ‰“å¼€æ–‡ä»¶åæ˜¾ç¤ºç›®å½•</p>
                    </div>
                </div>
                <div id="section-files" class="sidebar-section">
                    <div id="recent-files-list">
                        <p class="toc-empty">æš‚æ— æœ€è¿‘æ–‡ä»¶</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="preview" id="preview">
            <div class="welcome">
                <h2>æ¬¢è¿ä½¿ç”¨ Mermaid Reader</h2>
                <p>ç‚¹å‡»"æ‰“å¼€æ–‡ä»¶"æŒ‰é’®é€‰æ‹© Markdown æ–‡ä»¶</p>
                <p>æ”¯æŒ Mermaid å›¾è¡¨æ¸²æŸ“ï¼ˆæµç¨‹å›¾ã€æ—¶åºå›¾ã€ç”˜ç‰¹å›¾ç­‰ï¼‰</p>
                <p id="load-status">æ­£åœ¨åˆå§‹åŒ–...</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ ====================
        let mermaidReady = false;
        let markedReady = false;
        let currentFileContent = '';
        let currentFileName = '';
        let headings = [];
        let headingObserver = null;
        let currentActiveHeading = null;
        let currentFontSize = 100;
        let isSourceView = false; // æ˜¯å¦ä¸ºæºç è§†å›¾æ¨¡å¼

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', function() {
            initSettings();
            checkLibraries();
            updateRecentFilesList();
        });

        // æ£€æŸ¥åº“åŠ è½½çŠ¶æ€
        async function checkLibraries() {
            const statusDiv = document.getElementById('status');
            const loadStatus = document.getElementById('load-status');
            
            // é¦–å…ˆæ˜¾ç¤ºåº“ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä¸ä¾èµ–åˆå§‹åŒ–çŠ¶æ€ï¼‰
            const libInfo = [];
            libInfo.push('ğŸ“¦ Mermaid.js v11.12.2');
            libInfo.push('ğŸ“¦ Marked.js v12.0.2');
            libInfo.push('ğŸ”’ DOMPurify v3.2.6 (å†…ç½®)');
            libInfo.push('ğŸ¨ Highlight.js v11.9.0');
            libInfo.push('ğŸš€ Wails v2.11.0');
            
            // åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„divå­˜æ”¾ç‰ˆæœ¬ä¿¡æ¯ï¼Œä¸ä¼šè¢«è¦†ç›–
            let versionInfoDiv = document.getElementById('version-info');
            if (!versionInfoDiv) {
                versionInfoDiv = document.createElement('div');
                versionInfoDiv.id = 'version-info';
                versionInfoDiv.style.cssText = 'background: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; font-size: 14px;';
                loadStatus.parentNode.insertBefore(versionInfoDiv, loadStatus);
            }
            
            versionInfoDiv.innerHTML = '<strong style="color: #2d3748;">ğŸ“š åº“ç‰ˆæœ¬ä¿¡æ¯ï¼š</strong>';
            libInfo.forEach(info => {
                versionInfoDiv.innerHTML += `<br>   ${info}`;
            });
            versionInfoDiv.innerHTML += '<br><small style="color: #666;">ï¼ˆè¿™äº›ä¿¡æ¯æœ‰åŠ©äºæ’æŸ¥æ¸²æŸ“é—®é¢˜ï¼‰</small>';
            
            loadStatus.innerHTML = 'æ­£åœ¨æ£€æŸ¥åº“åŠ è½½çŠ¶æ€...';
            
            // ç­‰å¾…mermaidåŠ è½½ï¼ˆæœ€å¤š10ç§’ï¼Œå¢åŠ ç­‰å¾…æ—¶é—´ï¼‰
            let mermaidCheckCount = 0;
            const maxWaitTime = 100; // 100æ¬¡ Ã— 100ms = 10ç§’
            while (typeof mermaid === 'undefined' && mermaidCheckCount < maxWaitTime) {
                await new Promise(resolve => setTimeout(resolve, 100));
                mermaidCheckCount++;
                if (mermaidCheckCount % 10 === 0) {
                    loadStatus.innerHTML = `ç­‰å¾… Mermaid åº“åŠ è½½... (${mermaidCheckCount * 100 / 1000}s)`;
                }
            }
            
            if (typeof mermaid !== 'undefined') {
                try {
                    loadStatus.innerHTML = 'Mermaid åº“å·²æ‰¾åˆ°ï¼Œæ­£åœ¨åˆå§‹åŒ–...';
                    // ç­‰å¾…mermaidå®Œå…¨åˆå§‹åŒ–ï¼ˆå¢åŠ ç­‰å¾…æ—¶é—´åˆ°2ç§’ï¼‰
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'base',
                        securityLevel: 'loose',
                        themeVariables: {
                            primaryColor: '#f0f4f8',
                            primaryBorderColor: '#4a90a4',
                            primaryTextColor: '#2d3748',
                            lineColor: '#5a7a8a',
                            secondaryColor: '#e8f4f8',
                            tertiaryColor: '#f7fafc',
                            fontSize: '14px'
                        }
                    });
                    
                    // æµ‹è¯•mermaidæ˜¯å¦çœŸæ­£å¯ç”¨ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
                    let testSuccess = false;
                    let testRetries = 0;
                    const maxRetries = 3;
                    
                    while (!testSuccess && testRetries < maxRetries) {
                        try {
                            if (window.addDebugInfo) window.addDebugInfo('å¯åŠ¨æµ‹è¯•', 'å¼€å§‹Mermaidæµ‹è¯•æ¸²æŸ“');
                            await mermaid.render('test-chart', 'graph TD;A-->B;');
                            testSuccess = true;
                            mermaidReady = true;
                            loadStatus.innerHTML += '<br>âœ… Mermaid æµ‹è¯•é€šè¿‡';
                        } catch (testError) {
                            if (window.addDebugInfo) window.addDebugInfo('å¯åŠ¨æµ‹è¯•', 'Mermaidæµ‹è¯•å¤±è´¥: ' + testError.message);
                            testRetries++;
                            if (testRetries < maxRetries) {
                                loadStatus.innerHTML = `âš ï¸ Mermaid æµ‹è¯•ä¸­ï¼Œé‡è¯• ${testRetries}/${maxRetries}...`;
                                await new Promise(resolve => setTimeout(resolve, 2000));
                            } else {
                                // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œä½†ä»ç„¶è®¤ä¸ºå°±ç»ª
                                mermaidReady = true;
                                loadStatus.innerHTML += '<br>âœ… Mermaid å°±ç»ªï¼ˆæµ‹è¯•æ¸²æŸ“è¢«è·³è¿‡ï¼‰';
                            }
                        }
                    }
                    
                    if (testSuccess) {
                        loadStatus.innerHTML += '<br>âœ… Mermaid åˆå§‹åŒ–æˆåŠŸ';
                    }
                } catch (error) {
                    loadStatus.innerHTML += '<br>âŒ Mermaid åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                }
            } else {
                loadStatus.innerHTML += '<br>âŒ Mermaid åº“æœªåŠ è½½ï¼ˆç­‰å¾…è¶…æ—¶ï¼‰';
            }
            
            // æ£€æŸ¥markedåº“
            loadStatus.innerHTML += '<br>æ­£åœ¨æ£€æŸ¥ Marked.js...';
            if (typeof marked !== 'undefined') {
                markedReady = true;
                loadStatus.innerHTML += '<br>âœ… Marked åº“å·²åŠ è½½';
                
                // é…ç½® marked
                const renderer = new marked.Renderer();
                renderer.code = function(code, infostring, escaped) {
                    const lang = (infostring || '').match(/^\S*/)?.[0] || '';
                    code = code.replace(/\n$/, '');
                    // å…³é”®ä¿®å¤ï¼šè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ä»£ç å—ä¸­çš„HTMLæ ‡ç­¾è¢«è§£æä¸ºDOMå…ƒç´ 
                    const escapedCode = code
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    if (!lang) {
                        return '<pre><code>' + escapedCode + '</code></pre>\n';
                    }
                    // æ˜¾ç¤ºè¯­è¨€åç§°åœ¨ä»£ç å—å·¦ä¸Šè§’
                    return `<div style="position: relative; margin: 15px 0;">
                        <div style="position: absolute; top: 0; left: 0; background: #e5e7eb; color: #ff4444; padding: 2px 10px; font-size: 12px; border-radius: 4px 0 4px 0; font-family: monospace; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${lang}</div>
                        <pre style="margin: 0; padding-top: 28px;"><code class="language-${lang}">${escapedCode}</code></pre>
                    </div>`;
                };
                marked.use({ renderer });
            } else {
                loadStatus.innerHTML += '<br>âŒ Marked åº“æœªåŠ è½½';
            }
            
            const allReady = mermaidReady && markedReady;
            statusDiv.textContent = allReady ? 'âœ… åº“å·²å°±ç»ª' : 'âš ï¸ åº“åŠ è½½æœ‰é—®é¢˜';
            
            // æœ€åæ·»åŠ å°±ç»ªæç¤º
            if (allReady) {
                loadStatus.innerHTML += '<br><br>âœ… æ‰€æœ‰åº“å·²å°±ç»ªï¼Œè¯·é€‰æ‹©æ–‡ä»¶å¼€å§‹';
            }
        }

        // ==================== æ–‡ä»¶æ“ä½œ ====================
        async function openFile() {
            try {
                if (window.go && window.go.main && window.go.main.App) {
                    const filePath = await window.go.main.App.OpenFileDialog();
                    if (filePath) {
                        const content = await window.go.main.App.ReadFile(filePath);
                        const fileName = await window.go.main.App.GetFileName(filePath);
                        await handleFileLoad(content, fileName);
                    }
                } else {
                    showError('Goåç«¯APIæœªå°±ç»ª');
                }
            } catch (error) {
                showError('æ‰“å¼€æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        async function handleFileLoad(content, fileName) {
            try {
                currentFileContent = content;
                currentFileName = fileName;
                
                // æå‰æ·»åŠ æ–‡ä»¶åæ—¥å¿—ï¼ˆæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆCï¼‰
                if (window.addDebugInfo) {
                    window.addDebugInfo('ç›®å½•æå–', 'è¯»å–æ–‡ä»¶: ' + fileName);
                }
                
                // æå–ç›®å½•ï¼ˆä¿æŒ1ä¸ªå‚æ•°è°ƒç”¨ï¼Œå‘åå…¼å®¹ï¼‰
                headings = extractHeadings(content);
                renderTOC(headings);
                
                // æ¸²æŸ“å†…å®¹
                await renderContent(content, fileName);
                
                // ä¿å­˜åˆ°æœ€è¿‘æ–‡ä»¶
                saveRecentFile(fileName, content);
                
                // åœ¨å·¥å…·æ æ˜¾ç¤ºæ–‡ä»¶åï¼ˆå·²åŠ è½½ï¼‰
                document.getElementById('filename-display').innerHTML = '<span class="filename-label">å·²åŠ è½½ï¼š</span>' + fileName;
            } catch (error) {
                showError('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        // ==================== ç›®å½•åŠŸèƒ½ ====================
        function generateId(text) {
            return 'heading-' + text.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '-').toLowerCase();
        }

        function extractHeadings(content) {
            // æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶å¤„ç†å†…å®¹å¤§å°ä¸º200KB
            const MAX_CONTENT_SIZE = 200000; // 200KBé™åˆ¶
            const isTruncated = content.length > MAX_CONTENT_SIZE;
            const processedContent = isTruncated ? 
                content.substring(0, MAX_CONTENT_SIZE) : 
                content;
            
            if (window.clearDebugInfo) window.clearDebugInfo();
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', '========== å¼€å§‹æå–ç›®å½• ==========');
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'è¾“å…¥å†…å®¹é•¿åº¦: ' + content.length + (isTruncated ? ' (å·²æˆªæ–­è‡³200KB)' : ''));
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'è¾“å…¥å‰200å­—ç¬¦: ' + processedContent.substring(0, 200).replace(/</g, '&lt;'));
            
            // å…ˆç”¨marked.parse()å¾—åˆ°HTMLï¼Œmarkedå·²ç»æ­£ç¡®å¤„ç†äº†ä»£ç å—å’Œç‰¹æ®Šæƒ…å†µ
            const html = marked.parse(processedContent);
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'marked.parse()æ‰§è¡Œå®Œæˆ');
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'ç”Ÿæˆçš„HTMLé•¿åº¦: ' + html.length);
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'HTMLå‰500å­—ç¬¦: ' + html.substring(0, 500).replace(/</g, '&lt;'));
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'åŒ…å«&lt;h1&gt;: ' + html.includes('<h1'));
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'åŒ…å«&lt;h2&gt;: ' + html.includes('<h2'));
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'åŒ…å«&lt;h3&gt;: ' + html.includes('<h3'));
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'åŒ…å«&lt;h4&gt;: ' + html.includes('<h4'));
            
            // ä»HTMLä¸­æå–h1-h6æ ‡ç­¾
            const headingRegex = /<h([1-6])[^>]*>(.*?)<\/h[1-6]>/gi;
            const result = [];
            let match;
            let matchCount = 0;
            const MAX_MATCHES = 200; // æœ€å¤šæå–200ä¸ªæ ‡é¢˜
            
            // æ·»åŠ æ€§èƒ½é™åˆ¶ï¼šé™åˆ¶æ ‡é¢˜æ•°é‡å’Œå¾ªç¯æ¬¡æ•°
            while ((match = headingRegex.exec(html)) !== null && matchCount < MAX_MATCHES) {
                matchCount++;
                const level = parseInt(match[1]);
                // ç§»é™¤HTMLæ ‡ç­¾ï¼Œè·å–çº¯æ–‡æœ¬
                const text = match[2].replace(/<[^>]+>/g, '').trim();
                if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', `åŒ¹é…åˆ°æ ‡é¢˜ #${matchCount}: "${text}" (çº§åˆ«: ${level})`);
                result.push({
                    level: level,
                    text: text,
                    id: generateId(text)
                });
            }
            
            // å¦‚æœæ ‡é¢˜æ•°é‡è¶…é™ï¼Œæ·»åŠ æç¤º
            if (matchCount >= MAX_MATCHES) {
                if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', 'âš ï¸ æ ‡é¢˜æ•°é‡è¶…è¿‡200ä¸ªï¼Œä»…æ˜¾ç¤ºå‰200ä¸ª');
            }
            
            if (window.addDebugInfo) window.addDebugInfo('ç›®å½•æå–', '========== å…±æå– ' + result.length + ' ä¸ªæ ‡é¢˜ ==========');
            return result;
        }

        function renderTOC(headings) {
            const container = document.getElementById('toc-container');

            if (headings.length === 0) {
                container.innerHTML = '<p class="toc-empty">æ–‡ä»¶ä¸­æ²¡æœ‰æ ‡é¢˜</p>';
                return;
            }

            let html = '';
            headings.forEach((heading) => {
                let style = 'padding-left:10px;';
                if (heading.level === 1) style = 'padding-left:5px;border-left:3px solid #0078d4;font-weight:bold;';
                if (heading.level === 2) style = 'padding-left:20px;';
                if (heading.level === 3) style = 'padding-left:35px;font-size:12px;';
                if (heading.level === 4) style = 'padding-left:50px;font-size:12px;color:#666;';
                if (heading.level === 5) style = 'padding-left:65px;font-size:12px;color:#888;font-style:italic;';
                if (heading.level === 6) style = 'padding-left:80px;font-size:11px;color:#999;font-style:italic;';

                html += '<div class="toc-item" style="' + style + '" onclick="scrollToHeading(\'' + heading.id + '\')" id="toc-' + heading.id + '">' + heading.text + '</div>';
            });

            container.innerHTML = html;
            setTimeout(initScrollSpy, 500);
        }

        function initScrollSpy() {
            const timestamp = new Date().toISOString();
            if (window.addDebugInfo) window.addDebugInfo('æ»šåŠ¨ç›‘å¬', '[' + timestamp + '] initScrollSpyè¢«è°ƒç”¨');
            
            if (headingObserver) {
                headingObserver.disconnect();
                if (window.addDebugInfo) window.addDebugInfo('æ»šåŠ¨ç›‘å¬', '[' + timestamp + '] æ–­å¼€æ—§Observer');
            }

            const preview = document.getElementById('preview');
            const headingElements = preview.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');

            if (headingElements.length === 0) {
                if (window.addDebugInfo) window.addDebugInfo('æ»šåŠ¨ç›‘å¬', '[' + timestamp + '] æœªæ‰¾åˆ°æ ‡é¢˜å…ƒç´ ï¼Œé€€å‡º');
                return;
            }
            
            if (window.addDebugInfo) window.addDebugInfo('æ»šåŠ¨ç›‘å¬', '[' + timestamp + '] æ‰¾åˆ°' + headingElements.length + 'ä¸ªæ ‡é¢˜å…ƒç´ ');

            headingObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const obsTimestamp = new Date().toISOString();
                        if (window.addDebugInfo) window.addDebugInfo('æ»šåŠ¨ç›‘å¬', '[' + obsTimestamp + '] æ ‡é¢˜è¿›å…¥è§†å£: ' + entry.target.id);
                        setActiveTOCItem(entry.target.id);
                    }
                });
            }, {
                rootMargin: '-80px 0px -60% 0px',
                threshold: 0
            });

            headingElements.forEach(heading => {
                headingObserver.observe(heading);
            });
            
            if (window.addDebugInfo) window.addDebugInfo('æ»šåŠ¨ç›‘å¬', '[' + timestamp + '] Observerå·²å¯åŠ¨ï¼Œç›‘å¬' + headingElements.length + 'ä¸ªå…ƒç´ ');
        }

        function setActiveTOCItem(headingId) {
            if (currentActiveHeading === headingId) return;
            currentActiveHeading = headingId;

            document.querySelectorAll('#toc-container .toc-item').forEach(item => {
                item.classList.remove('active');
            });

            const tocItem = document.getElementById('toc-' + headingId);
            if (tocItem) {
                tocItem.classList.add('active');
                tocItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function scrollToHeading(id) {
            const timestamp = new Date().toISOString();
            if (window.addDebugInfo) window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] scrollToHeadingè¢«è°ƒç”¨, id=' + id);
            
            const element = document.getElementById(id);
            if (window.addDebugInfo) {
                window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] æŸ¥æ‰¾å…ƒç´ ç»“æœ: ' + (element ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'));
                if (element) {
                    window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] å…ƒç´ æ ‡ç­¾: ' + element.tagName);
                    window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] å…ƒç´ innerText: ' + element.innerText.substring(0, 50));
                    window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] å…ƒç´ ä½ç½®: top=' + element.getBoundingClientRect().top + ', left=' + element.getBoundingClientRect().left);
                    window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] è§†å£æ»šåŠ¨ä½ç½®: scrollY=' + window.scrollY + ', scrollTop=' + document.documentElement.scrollTop);
                    const preview = document.getElementById('preview');
                    window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] previewæ»šåŠ¨ä½ç½®: scrollTop=' + (preview ? preview.scrollTop : 'null'));
                }
            }
            
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                if (window.addDebugInfo) window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] å·²æ‰§è¡ŒscrollIntoView, ç›®æ ‡å…ƒç´ : ' + id);
                
                document.querySelectorAll('.toc-item').forEach(item => {
                    item.classList.remove('active');
                });
                const tocItem = document.getElementById('toc-' + id);
                if (window.addDebugInfo) window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] TOCé¡¹æŸ¥æ‰¾: ' + (tocItem ? 'æ‰¾åˆ°toc-' + id : 'æœªæ‰¾åˆ°toc-' + id));
                if (tocItem) {
                    tocItem.classList.add('active');
                    if (window.addDebugInfo) window.addDebugInfo('ç‚¹å‡»ç›®å½•', '[' + timestamp + '] å·²æ·»åŠ activeç±»åˆ°TOCé¡¹');
                }
            }
        }

        // ==================== å†…å®¹æ¸²æŸ“ ====================
         // å…¨å±€è®¡æ•°å™¨ï¼Œç”¨äºè¿½è¸ªå½“å‰æ˜¯ç¬¬å‡ ä¸ªå›¾è¡¨ï¼ˆä»1å¼€å§‹ï¼‰
         let currentChartIndex = 0;
         
         function fixMermaidCode(code) {
              let fixedCode = code;

               // ===== v1.6.20 ç²¾ç¡®ä¿®å¤è§„åˆ™ =====
              // è§„åˆ™1: åªä¿®å¤æ–¹æ‹¬å·å†…åŒ…å«ç®¡é“ç¬¦çš„æ¨¡å¼ï¼ˆ| â†’ /ï¼‰
              // è§„åˆ™2: åªåœ¨å¼•å·å†…å®¹åŒ…å«ç®¡é“ç¬¦æ—¶æ›¿æ¢ï¼ˆ"" â†’ ã€Šã€‹ï¼‰
              // è§„åˆ™3: æ–¹æ‹¬å·å†…çš„ () â†’ ã€Šã€‹ï¼ˆMermaid æ–¹æ‹¬å·å†…ä¸æ”¯æŒåœ†æ‹¬å·ï¼‰
              if (currentChartIndex <= 21) {
                  if (window.addDebugInfo) window.addDebugInfo('è‡ªåŠ¨ä¿®å¤', `å›¾è¡¨ #${currentChartIndex}: åº”ç”¨ç²¾ç¡®ä¿®å¤è§„åˆ™ï¼ˆä»…ä¿®å¤åŒ…å«|çš„æ¨¡å¼ï¼‰`);

                  // è§„åˆ™1: æ–¹æ‹¬å·å†…çš„ | â†’ /ï¼ˆåªä¿®å¤åŒ…å«ç®¡é“ç¬¦çš„æ–¹æ‹¬å·ï¼‰
                  fixedCode = fixedCode.replace(/\[([^\[\]]*\|[^\[\]]*)\]/g, (match, content) => {
                      const replacedContent = content.replace(/\|/g, '/');
                      return '[' + replacedContent + ']';
                  });

                   // è§„åˆ™2: åªåœ¨åŒ…å« | çš„å¼•å·å†…å®¹ä¸­æ›¿æ¢ "" â†’ ã€Šã€‹
                  // é¿å…è¯¯ä¼¤åˆæ³•ä»£ç å¦‚ Logo["[LOGOå›¾æ ‡]"]
                  fixedCode = fixedCode.replace(/"([^"]*\|[^"]*)"/g, (match, content) => {
                      return 'ã€Š' + content.replace(/\|/g, '/') + 'ã€‹';
                  });

                  // è§„åˆ™3: æ–¹æ‹¬å·å†…çš„ () â†’ ã€Šã€‹ï¼ˆMermaid æ–¹æ‹¬å·å†…ä¸æ”¯æŒåœ†æ‹¬å·ï¼‰
                  // åªä¿®å¤æ–¹æ‹¬å·å†…çš„åœ†æ‹¬å·ï¼Œä¸å½±å“å¼•å·å†…çš„åœ†æ‹¬å·
                  fixedCode = fixedCode.replace(/\[([^\[\]]*\([^\[\]]*\)[^\[\]]*)\]/g, (match, content) => {
                      return '[' + content.replace(/\(/g, 'ã€Š').replace(/\)/g, 'ã€‹') + ']';
                  });

                  if (window.addDebugInfo) window.addDebugInfo('è‡ªåŠ¨ä¿®å¤', `å›¾è¡¨ #${currentChartIndex}: ç²¾ç¡®ä¿®å¤å®Œæˆ`);
              }

              // 1. å¤„ç†Â©ç¬¦å· - åªåœ¨æ–¹æ‹¬å·å†…éƒ¨å¤„ç†
             if (fixedCode.includes('Â©') || fixedCode.includes('(C)') || fixedCode.includes('(c)')) {
                 fixedCode = fixedCode.replace(/\[([^\]]*?)\s*\(\s*[cCÂ©]\s*\)\s*([^\]]*?)\]/g, (match, before, after) => {
                     const cleaned = before + ' ' + after;
                     return '[' + cleaned.trim() + ']';
                 });
             }
            
            // 2. å¤„ç†ç‰¹æ®Šç ´æŠ˜å·
            if (/[â€”â€“]/.test(fixedCode)) {
                fixedCode = fixedCode.replace(/[â€”â€“]/g, '---');
            }
            
            // 3. ä¿®å¤ [[...]] åŒå±‚æ–¹æ‹¬å·è¯­æ³• - Mermaid 10.x ä¸æ”¯æŒ
            if (/\[\[/.test(fixedCode)) {
                fixedCode = fixedCode.replace(/\[\[([^\]]+?)\]\](?!\])/g, '["$1"]');
            }
            
            // 4. ç§»é™¤bræ ‡ç­¾
            if (/<br\s*\/?>/i.test(fixedCode)) {
                fixedCode = fixedCode.replace(/<br\s*\/?>/gi, ' ');
            }
            
            // 5. å¤„ç†æ–¹æ‹¬å·æ–‡æœ¬ä¸­æœªè½¬ä¹‰çš„å¼•å· - ä»app.htmlå®Œå…¨å¤åˆ¶
            fixedCode = fixedCode.replace(/(\w+)\[("|"|"|"|'|'|"|"|"|")(.*?)\2\]/g, (match, id, quote, text) => {
                if (text.includes(quote)) {
                    return `${id}[${text.replace(new RegExp(quote, 'g'), '')}]`;
                }
                return match;
            });
            
            return fixedCode;
        }

        function parseMarkdownWithIds(text) {
            if (!markedReady) {
                return text;
            }

            let html = marked.parse(text);

            html = html.replace(/<h([1-6])[^>]*>(.*?)<\/h\1>/gi, (match, level, title) => {
                const id = generateId(title.replace(/<[^>]+>/g, '').trim());
                return `<h${level} id="${id}">${title}</h${level}>`;
            });

            return html;
        }

        // ==================== ä¸‰å±‚é˜²å¾¡ä½“ç³» - è¾…åŠ©å‡½æ•° ====================

        function escapeHtml(text) {
            if (window.addDebugInfo) window.addDebugInfo('escapeHtml', 'ã€è¿›å…¥ã€‘å‚æ•°é•¿åº¦: ' + (text ? text.length : 0));
            if (!text) {
                if (window.addDebugInfo) window.addDebugInfo('escapeHtml', 'ã€é€€å‡ºã€‘è¿”å›ç©ºå­—ç¬¦ä¸²');
                return '';
            }
            const result = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
            if (window.addDebugInfo) window.addDebugInfo('escapeHtml', 'ã€é€€å‡ºã€‘è½¬ä¹‰å®Œæˆ');
            return result;
        }

        function showErrorNotification(message, details) {
            let notificationContainer = document.getElementById('error-notification-container');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'error-notification-container';
                notificationContainer.style.cssText = 'position: fixed; bottom: 20px; left: 20px; z-index: 9999; max-width: 400px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;';
                document.body.appendChild(notificationContainer);
            }
            
            const notification = document.createElement('div');
            notification.style.cssText = 'background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px 16px; margin-top: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);';
            notification.innerHTML = '<div style="display: flex; align-items: start; gap: 10px;"><span style="color: #dc2626; font-size: 18px;">âš ï¸</span><div style="flex: 1;"><div style="color: #991b1b; font-weight: 600; font-size: 14px;">' + escapeHtml(message) + '</div>' + (details ? '<details style="margin-top: 8px;"><summary style="color: #dc2626; font-size: 11px; cursor: pointer;">æŸ¥çœ‹è¯¦æƒ…</summary><pre style="margin-top: 8px; padding: 8px; background: #fef2f2; border-radius: 4px; font-size: 10px; overflow-x: auto; color: #7f1d1d;">' + escapeHtml(details) + '</pre></details>' : '') + '</div><button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px; padding: 0;">Ã—</button></div>';
            
            notificationContainer.appendChild(notification);
            setTimeout(function() { if (notification.parentNode) notification.remove(); }, 10000);
        }

        async function validateMermaidCode(code) {
            if (window.addDebugInfo) window.addDebugInfo('validateMermaidCode', 'ã€è¿›å…¥ã€‘ä»£ç é•¿åº¦: ' + (code ? code.length : 0));
            // å‰ç½®æ£€æŸ¥ï¼šå‚æ•°æœ‰æ•ˆæ€§
            if (!code || typeof code !== 'string') {
                if (window.addDebugInfo) window.addDebugInfo('validateMermaidCode', 'ã€é€€å‡ºã€‘å‚æ•°æ— æ•ˆ');
                return { valid: false, error: 'ä»£ç ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯' };
            }
            
            // å‰ç½®æ£€æŸ¥ï¼šMermaidåº“å°±ç»ªçŠ¶æ€
            if (typeof mermaid === 'undefined' || !mermaid.parse) {
                if (window.addDebugInfo) window.addDebugInfo('validateMermaidCode', 'ã€é€€å‡ºã€‘Mermaidåº“æœªå°±ç»ª');
                return { valid: false, error: 'Mermaidåº“æœªå°±ç»ª' };
            }
            
            try {
                await mermaid.parse(code);
                if (window.addDebugInfo) window.addDebugInfo('validateMermaidCode', 'ã€é€€å‡ºã€‘è¯­æ³•éªŒè¯é€šè¿‡');
                return { valid: true, error: null };
            } catch (error) {
                if (window.addDebugInfo) window.addDebugInfo('validateMermaidCode', 'ã€é€€å‡ºã€‘è¯­æ³•éªŒè¯å¤±è´¥');
                return { valid: false, error: error.message || 'è¯­æ³•é”™è¯¯' };
            }
        }

        function cleanupMermaidErrorElements(chartId) {
            if (window.addDebugInfo) window.addDebugInfo('cleanupMermaidErrorElements', 'ã€è¿›å…¥ã€‘chartId: ' + chartId);
            const possibleIds = [chartId, 'd' + chartId, 'i' + chartId, 'd' + chartId.replace('chart-', ''), 'i' + chartId.replace('chart-', '')];
            let cleanedCount = 0;
            
            // å¤ç”¨ checkAndCleanupMermaidError è¿›è¡Œç»Ÿä¸€æ¸…ç†
            possibleIds.forEach(function(id) {
                try {
                    const el = document.getElementById(id);
                    if (el && checkAndCleanupMermaidError(el)) {
                        cleanedCount++;
                    }
                } catch (e) {}
            });
            
            // æ¸…ç†æ‰€æœ‰å¯èƒ½åŒ…å«é”™è¯¯çš„SVGå…ƒç´ 
            try {
                document.querySelectorAll('svg').forEach(function(svg) {
                    if (checkAndCleanupMermaidError(svg)) {
                        cleanedCount++;
                    }
                });
            } catch (e) {}
            
            if (window.addDebugInfo) window.addDebugInfo('cleanupMermaidErrorElements', 'ã€é€€å‡ºã€‘æ¸…ç†å®Œæˆ: ' + cleanedCount + ' ä¸ª');
        }

        function checkAndCleanupMermaidError(element) {
            if (!element || element.nodeType !== 1) return false;
            try {
                const isErrorSvg = element.tagName === 'SVG' && element.textContent && element.textContent.includes('Syntax error in text');
                const hasErrorText = element.querySelector && element.querySelector('.error-text');
                const isErrorContainer = element.id && (element.id.startsWith('dchart') || element.id.startsWith('ichart') || element.id.startsWith('chart-')) && element.textContent && element.textContent.includes('Syntax error');
                
                if (isErrorSvg || hasErrorText || isErrorContainer) {
                    // å…³é”®ä¿®æ”¹ï¼šåˆ é™¤å‰ä¿å­˜å…ƒç´ ä¿¡æ¯ï¼Œé¿å…è®¿é—®å·²åˆ é™¤å…ƒç´ 
                    const elementInfo = element.id || element.tagName || 'unknown-element';
                    
                    element.remove();
                    // å®‰å…¨ï¼šä½¿ç”¨ä¿å­˜çš„ä¿¡æ¯
                    if (window.addDebugInfo) window.addDebugInfo('checkAndCleanupMermaidError', 'ã€æ¸…ç†ã€‘é”™è¯¯å…ƒç´ : ' + elementInfo);
                    return true;
                }
            } catch (e) {}
            return false;
        }

        // ==================== ä¸‰å±‚é˜²å¾¡ä½“ç³» - è¾…åŠ©å‡½æ•°ç»“æŸ ====================

        async function renderContent(content, fileName) {
            const timestamp = new Date().toISOString();
            if (window.addDebugInfo) window.addDebugInfo('æ¸²æŸ“æµç¨‹', '[' + timestamp + '] renderContentè¢«è°ƒç”¨, fileName=' + fileName);
            
            const preview = document.getElementById('preview');
            // æ˜¾ç¤ºå±…ä¸­çš„æ ‡é¢˜è¡Œï¼šå·²åŠ è½½ï¼šæ–‡ä»¶åï¼ˆè¶…é•¿æˆªæ–­ï¼‰
            preview.innerHTML = '<h2 id="file-title-' + fileName + '">' + fileName + '</h2>';
            
            // é¦–å…ˆï¼Œå°†å†…å®¹è½¬æ¢ä¸ºHTMLï¼ˆè¿™ä¼šæ­£ç¡®å¤„ç†ä»£ç å—ï¼Œé¿å…ä»£ç å—å†…çš„mermaidè¢«åŒ¹é…ï¼‰
            const textHtml = parseMarkdownWithIds(content);
            preview.innerHTML += '<div class="text-content" id="temp-content">' + textHtml + '</div>';
            
            // ç„¶åï¼Œåœ¨ç”Ÿæˆçš„HTMLä¸­æŸ¥æ‰¾mermaidä»£ç å—ï¼ˆæ­¤æ—¶ä»£ç å—å†…çš„mermaidç¤ºä¾‹ä¸ä¼šè¢«åŒ¹é…ï¼‰
            const mermaidCodeBlocks = preview.querySelectorAll('pre code.language-mermaid');
            
            if (mermaidCodeBlocks.length === 0) {
                // æ²¡æœ‰mermaidå›¾è¡¨ï¼Œç›´æ¥å®Œæˆ
                initScrollSpy();
                return;
            }
            
            let chartCount = 0;
            let successCount = 0;
            let failedCharts = [];
            
            // éå†æ‰€æœ‰mermaidä»£ç å—å¹¶æ¸²æŸ“
            for (let i = 0; i < mermaidCodeBlocks.length; i++) {
                const codeBlock = mermaidCodeBlocks[i];
                const originalCode = codeBlock.textContent;
                
                // æ£€æµ‹æ˜¯å¦ä¸ºæ•™å­¦ç¤ºä¾‹ï¼ˆä¸åº”æ¸²æŸ“ä¸ºå›¾è¡¨ï¼‰
                const isTeachingExample = (code) => {
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•™å­¦æ³¨é‡Š
                    if (code.includes('// ä¸æ¨è') || code.includes('// é”™è¯¯') || code.includes('// ä¸æ¨è:')) {
                        return true;
                    }
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤šä¸ªå›¾è¡¨å®šä¹‰
                    const diagramCount = (code.match(/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|erDiagram|journey|gantt)/gm) || []).length;
                    if (diagramCount > 1) {
                        return true;
                    }
                    return false;
                };

                // å¦‚æœæ˜¯æ•™å­¦ç¤ºä¾‹ï¼Œè·³è¿‡æ¸²æŸ“
                if (isTeachingExample(originalCode)) {
                    console.log('æ£€æµ‹åˆ°æ•™å­¦ç¤ºä¾‹ï¼Œä¿æŒä»£ç å—åŸæ ·:', originalCode.substring(0, 50));
                    if (window.addDebugInfo) window.addDebugInfo('Mermaidæ¸²æŸ“', 'è·³è¿‡æ•™å­¦ç¤ºä¾‹ #' + i);
                    continue; // è·³è¿‡è¿™ä¸ªä»£ç å—ï¼Œä¸æ¸²æŸ“ä¸ºå›¾è¡¨
                }
                
                // è®¾ç½®å½“å‰å›¾è¡¨ç´¢å¼•ï¼ˆä»1å¼€å§‹è®¡æ•°ï¼‰
                currentChartIndex = i + 1;
                
                const fixedCode = fixMermaidCode(originalCode);
                
                const chartId = 'chart-' + Date.now() + '-' + i;
                chartCount++;
                
                if (window.addDebugInfo) window.addDebugInfo('Mermaidæ¸²æŸ“', 'å¼€å§‹æ¸²æŸ“å›¾è¡¨ #' + i + ', ID=' + chartId);
                
                // ========== ç¬¬ä¸€å±‚é˜²å¾¡ï¼šè¯­æ³•é¢„æ£€ ==========
                const validation = await validateMermaidCode(fixedCode);
                if (!validation.valid) {
                    showErrorNotification('å›¾è¡¨ #' + (i + 1) + ' è¯­æ³•éªŒè¯å¤±è´¥', validation.error);
                    failedCharts.push({
                        chartIndex: i + 1,
                        errorMessage: validation.error,
                        codePreview: originalCode.substring(0, 100)
                    });
                    continue;
                }
                // ========== ç¬¬ä¸€å±‚é˜²å¾¡ç»“æŸ ==========
                
                try {
                    const result = await mermaid.render(chartId, fixedCode);
                    if (window.addDebugInfo) window.addDebugInfo('Mermaidæ¸²æŸ“', 'å›¾è¡¨ #' + i + ' æ¸²æŸ“æˆåŠŸ');
                    
                    if (result && result.svg) {
                        // åˆ›å»ºå›¾è¡¨å®¹å™¨æ›¿æ¢ä»£ç å—
                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'mermaid-container';
                        chartContainer.innerHTML = result.svg;
                        
                        // æ›¿æ¢preå…ƒç´ ï¼ˆä¿ç•™åœ¨æ–‡æœ¬æµä¸­çš„ä½ç½®ï¼‰
                        const preElement = codeBlock.closest('pre');
                        if (preElement && preElement.parentNode) {
                            preElement.parentNode.replaceChild(chartContainer, preElement);
                        }
                        successCount++;
                    }
                } catch (renderError) {
                    // ========== ç¬¬äºŒå±‚é˜²å¾¡ï¼šæ¸…ç†é”™è¯¯SVG ==========
                    cleanupMermaidErrorElements(chartId);
                    // ========== ç¬¬äºŒå±‚é˜²å¾¡ç»“æŸ ==========
                    
                    // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼ˆä¸ç¬¬ä¸€å±‚é˜²å¾¡ä¿æŒä¸€è‡´çš„ç”¨æˆ·ä½“éªŒï¼‰
                    showErrorNotification('å›¾è¡¨ #' + (i + 1) + ' æ¸²æŸ“å¤±è´¥', renderError.message || 'æœªçŸ¥é”™è¯¯');
                    
                    // è®°å½•å¤±è´¥ä¿¡æ¯
                    const errorInfo = {
                        chartIndex: i + 1,
                        errorMessage: renderError.message || 'æœªçŸ¥é”™è¯¯',
                        codePreview: originalCode.substring(0, 100)
                    };
                    failedCharts.push(errorInfo);
                    
                    // ä¿ç•™åŸå§‹ä»£ç å—ï¼Œä¸æ¸²æŸ“æˆå›¾è¡¨
                    // é”™è¯¯æç¤ºå·²é€šè¿‡ showErrorNotification æ˜¾ç¤º
                    console.log('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', errorInfo);
                    if (window.addDebugInfo) window.addDebugInfo('Mermaidæ¸²æŸ“', 'å›¾è¡¨ #' + i + ' æ¸²æŸ“å¤±è´¥: ' + renderError.message);
                }
            }
            
            // ç§»é™¤ä¸´æ—¶ID
            const tempContent = document.getElementById('temp-content');
            if (tempContent) {
                tempContent.removeAttribute('id');
            }
            
            // æ˜¾ç¤ºæ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
            if (chartCount > 0) {
                preview.innerHTML += '<div class="text-content" style="margin-top: 20px;">';
                preview.innerHTML += '<h3 style="margin-bottom: 10px;">ğŸ“Š æ¸²æŸ“ç»Ÿè®¡</h3>';
                preview.innerHTML += '<p>æ€»å›¾è¡¨æ•°: ' + chartCount + ' | æˆåŠŸ: ' + successCount + ' | å¤±è´¥: ' + (chartCount - successCount) + '</p>';
                
                if (failedCharts.length > 0) {
                    preview.innerHTML += '<details style="margin-top: 10px; font-size: 12px;">';
                    preview.innerHTML += '<summary style="cursor: pointer; color: #c53030; font-weight: bold;">ğŸ” ç‚¹å‡»æŸ¥çœ‹å¤±è´¥è¯¦æƒ…ï¼ˆç”¨äºè°ƒè¯•åˆ†æï¼‰</summary>';
                    preview.innerHTML += '<pre style="background: #f7fafc; padding: 10px; overflow: auto; max-height: 300px; font-size: 11px; line-height: 1.4;">' + 
                        JSON.stringify(failedCharts, null, 2) + '</pre>';
                    preview.innerHTML += '</details>';
                }
                
                if (successCount === chartCount) {
                    preview.innerHTML += '<p class="success-message" style="margin-top: 10px;">âœ… æ‰€æœ‰å›¾è¡¨æ¸²æŸ“æˆåŠŸï¼</p>';
                } else if (successCount > 0) {
                    preview.innerHTML += '<p class="warning-message" style="margin-top: 10px;">âš ï¸ éƒ¨åˆ†å›¾è¡¨æ¸²æŸ“å¤±è´¥ï¼Œå·²è·³è¿‡é”™è¯¯å›¾è¡¨</p>';
                } else {
                    preview.innerHTML += '<p class="error" style="margin-top: 10px;">âŒ æ‰€æœ‰å›¾è¡¨æ¸²æŸ“å¤±è´¥</p>';
                }
                preview.innerHTML += '</div>';
            }
            
            // å¯¹æ‰€æœ‰é Mermaid ä»£ç å—åº”ç”¨è¯­æ³•é«˜äº®
            try {
                if (typeof hljs !== 'undefined') {
                    const codeBlocks = preview.querySelectorAll('pre code:not(.language-mermaid)');
                    codeBlocks.forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    if (window.addDebugInfo) window.addDebugInfo('æ¸²æŸ“æµç¨‹', 'Highlight.js è¯­æ³•é«˜äº®å®Œæˆï¼Œå¤„ç†äº† ' + codeBlocks.length + ' ä¸ªä»£ç å—');
                }
            } catch (highlightError) {
                console.warn('Highlight.js é«˜äº®å¤±è´¥:', highlightError);
                if (window.addDebugInfo) window.addDebugInfo('æ¸²æŸ“æµç¨‹', 'Highlight.js é«˜äº®å¤±è´¥: ' + highlightError.message);
            }
            
            // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬ï¼ˆå¿…é¡»åœ¨å›¾è¡¨æ¸²æŸ“å®Œæˆåï¼‰
            initScrollSpy();
        }

        // ==================== ä¸»é¢˜ä¸å­—ä½“ ====================
        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            
            if (isDark) {
                body.setAttribute('data-theme', 'light');
                document.getElementById('theme-icon').textContent = 'ğŸŒ™';
                localStorage.setItem('mermaidReaderTheme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
                localStorage.setItem('mermaidReaderTheme', 'dark');
            }
        }

        function adjustFontSize(delta) {
            const newSize = currentFontSize + delta * 10;
            if (newSize >= 80 && newSize <= 150) {
                currentFontSize = newSize;
                applyFontSize();
            }
        }

        function applyFontSize() {
            // åº”ç”¨åˆ°é¢„è§ˆåŒºåŸŸåŠå…¶æ‰€æœ‰å­å…ƒç´ 
            const preview = document.getElementById('preview');
            if (preview) {
                preview.style.fontSize = currentFontSize + '%';
                // ç¡®ä¿æ‰€æœ‰æ–‡æœ¬å†…å®¹åŒºåŸŸä¹Ÿåº”ç”¨å­—ä½“å¤§å°
                const textContents = preview.querySelectorAll('.text-content');
                textContents.forEach(el => {
                    el.style.fontSize = 'inherit';
                });
            }
            const display = document.getElementById('font-size-display');
            if (display) {
                display.textContent = currentFontSize + '%';
            }
            localStorage.setItem('mermaidReaderFontSize', currentFontSize);
        }

        function initSettings() {
            const savedFontSize = localStorage.getItem('mermaidReaderFontSize');
            if (savedFontSize) {
                currentFontSize = parseInt(savedFontSize);
            }
            applyFontSize();

            const savedTheme = localStorage.getItem('mermaidReaderTheme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            } else {
                document.body.setAttribute('data-theme', 'light');
            }
            
            // æ¢å¤ä¾§è¾¹æ Tabé€‰ä¸­çŠ¶æ€
            restoreSidebarTab();
            
            // è·å–å¹¶æ˜¾ç¤ºåº”ç”¨ç‰ˆæœ¬å·
            loadAppVersion();
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºåº”ç”¨ç‰ˆæœ¬å·
        async function loadAppVersion() {
            try {
                if (window.go && window.go.main && window.go.main.App) {
                    const version = await window.go.main.App.GetVersion();
                    // æ›´æ–°title
                    document.title = 'Mermaid Reader v' + version;
                    // æ›´æ–°å·¥å…·æ ç‰ˆæœ¬æ˜¾ç¤º
                    const versionSpan = document.getElementById('app-version');
                    if (versionSpan) {
                        versionSpan.textContent = 'v' + version;
                    }
                    // æ›´æ–°æ¬¢è¿é¡µé¢æ ‡é¢˜
                    updateWelcomeVersion(version);
                }
            } catch (error) {
                console.log('è·å–ç‰ˆæœ¬å·å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ¬¢è¿é¡µé¢ä¸­çš„ç‰ˆæœ¬å·
        function updateWelcomeVersion(version) {
            const welcomeTitles = document.querySelectorAll('.welcome h2');
            welcomeTitles.forEach(h2 => {
                if (h2.textContent.includes('Mermaid Reader')) {
                    h2.innerHTML = 'æ¬¢è¿ä½¿ç”¨ Mermaid Reader <span style="font-size: 0.7em; color: #666;">v' + version + '</span>';
                }
            });
        }

        // ==================== æœ€è¿‘æ–‡ä»¶ ====================
        function saveRecentFile(name, content) {
            let recentFiles = JSON.parse(localStorage.getItem('mermaidRecentFiles') || '[]');
            recentFiles = recentFiles.filter(f => f.name !== name);
            recentFiles.unshift({ name, content, time: Date.now() });
            if (recentFiles.length > 10) {
                recentFiles = recentFiles.slice(0, 10);
            }
            localStorage.setItem('mermaidRecentFiles', JSON.stringify(recentFiles));
            updateRecentFilesList();
        }

        function updateRecentFilesList() {
            const list = document.getElementById('recent-files-list');
            const recentFiles = JSON.parse(localStorage.getItem('mermaidRecentFiles') || '[]');
            
            if (recentFiles.length === 0) {
                list.innerHTML = '<p class="toc-empty">æš‚æ— æœ€è¿‘æ–‡ä»¶</p>';
                return;
            }
            
            let html = '';
            recentFiles.forEach(file => {
                html += '<div class="recent-file-item" onclick="loadRecentFile(\'' + file.name + '\')">' + file.name + '</div>';
            });
            list.innerHTML = html;
        }

        // ==================== ä¾§è¾¹æ Tabåˆ‡æ¢ ====================
        function switchSidebarTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.sidebar-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // æ·»åŠ activeç±»åˆ°å½“å‰é€‰ä¸­çš„tabå’Œsection
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('section-' + tabName).classList.add('active');
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„tabåˆ°localStorageï¼ˆå¯é€‰ï¼Œè®°ä½ç”¨æˆ·åå¥½ï¼‰
            localStorage.setItem('mermaidReaderActiveTab', tabName);
        }

        // æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„tabï¼ˆé¡µé¢åŠ è½½æ—¶ï¼‰
        function restoreSidebarTab() {
            const savedTab = localStorage.getItem('mermaidReaderActiveTab');
            if (savedTab && (savedTab === 'toc' || savedTab === 'files')) {
                switchSidebarTab(savedTab);
            }
        }

        async function loadRecentFile(fileName) {
            const recentFiles = JSON.parse(localStorage.getItem('mermaidRecentFiles') || '[]');
            const file = recentFiles.find(f => f.name === fileName);
            if (file && file.content) {
                await handleFileLoad(file.content, file.name);
            }
        }

        // ==================== å…¶ä»–åŠŸèƒ½ ====================
        function clearContent() {
            const preview = document.getElementById('preview');
            preview.innerHTML = `
                <div class="welcome">
                    <h2>æ¬¢è¿ä½¿ç”¨ Mermaid Reader</h2>
                    <p>ç‚¹å‡»"æ‰“å¼€æ–‡ä»¶"æŒ‰é’®é€‰æ‹©Markdownæ–‡ä»¶</p>
                    <p>æ”¯æŒMermaidå›¾è¡¨æ¸²æŸ“ï¼ˆæµç¨‹å›¾ã€æ—¶åºå›¾ã€ç”˜ç‰¹å›¾ç­‰ï¼‰</p>
                    <p>âœ… åº“å·²å°±ç»ªï¼Œè¯·é€‰æ‹©æ–‡ä»¶å¼€å§‹æ¸²æŸ“</p>
                </div>
            `;
            document.getElementById('toc-container').innerHTML = '<p class="toc-empty">æ‰“å¼€æ–‡ä»¶åæ˜¾ç¤ºç›®å½•</p>';
            headings = [];
            currentFileContent = '';
            currentFileName = '';
            document.getElementById('status').textContent = '';
            document.getElementById('filename-display').innerHTML = ''; // æ¸…ç©ºæ–‡ä»¶åæ˜¾ç¤º
        }

        // ==================== é€šçŸ¥åŠŸèƒ½ ====================
        function showNotification(type, message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                z-index: 9999;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: all 0.3s ease;
            `;
            
            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            switch(type) {
                case 'success':
                    notification.style.background = '#10b981';
                    notification.style.color = 'white';
                    break;
                case 'error':
                    notification.style.background = '#ef4444';
                    notification.style.color = 'white';
                    break;
                case 'warning':
                    notification.style.background = '#f59e0b';
                    notification.style.color = 'white';
                    break;
                default:
                    notification.style.background = '#3b82f6';
                    notification.style.color = 'white';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ==================== å¯¼å‡ºåŠŸèƒ½ ====================
        function exportWord() {
            if (!currentFileContent) {
                showNotification('warning', 'è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            // ä½¿ç”¨ Promise å¤„ç†å¼‚æ­¥
            (async () => {
                try {
                    console.log('å¼€å§‹å¯¼å‡ºWord...');
                    console.log('currentFileContenté•¿åº¦:', currentFileContent.length);
                    
                    // è·å–å»ºè®®çš„æ–‡ä»¶å
                    const suggestedName = currentFileName ? currentFileName.replace(/\.md$/i, '.docx') : 'document.docx';
                    console.log('å»ºè®®æ–‡ä»¶å:', suggestedName);
                    
                    // æ£€æŸ¥ window.go.main.App.ExportMarkdownToDocx æ˜¯å¦å¯ç”¨
                    if (!window.go || !window.go.main || !window.go.main.App || !window.go.main.App.ExportMarkdownToDocx) {
                        console.error('ExportMarkdownToDocx æœªç»‘å®šåˆ° Wails');
                        showNotification('error', 'å¯¼å‡ºåŠŸèƒ½æœªåˆå§‹åŒ–ï¼Œè¯·é‡å¯åº”ç”¨');
                        return;
                    }
                    
                    // è°ƒç”¨åç«¯å¯¼å‡º DOCXï¼ˆä½¿ç”¨æ­£ç¡®çš„ Wails è°ƒç”¨æ–¹å¼ï¼‰
                    console.log('è°ƒç”¨ window.go.main.App.ExportMarkdownToDocx...');
                    const savedPath = await window.go.main.App.ExportMarkdownToDocx(currentFileContent, suggestedName);
                    
                    console.log('è¿”å›ç»“æœ:', savedPath);
                    if (savedPath) {
                        showNotification('success', `Word æ–‡æ¡£å·²ä¿å­˜åˆ°: ${savedPath}`);
                        console.log('Wordå¯¼å‡ºæˆåŠŸ:', savedPath);
                    } else {
                        showNotification('warning', 'å¯¼å‡ºè¢«å–æ¶ˆæˆ–æœªå®Œæˆ');
                    }
                } catch (error) {
                    console.error('Wordå¯¼å‡ºå¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                    showNotification('error', 'Wordå¯¼å‡ºå¤±è´¥: ' + (error.message || error));
                }
            })();
        }

        function exportPDF() {
            if (!currentFileContent) {
                showNotification('warning', 'è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            // è·å–é¢„è§ˆåŒºåŸŸçš„å·²æ¸²æŸ“å†…å®¹ï¼ˆåŒ…å«Mermaid SVGï¼‰
            const previewContent = document.getElementById('preview');
            if (!previewContent || !previewContent.innerHTML.trim()) {
                showNotification('warning', 'è¯·å…ˆç­‰å¾…å†…å®¹æ¸²æŸ“å®Œæˆ');
                return;
            }
            
            try {
                // ä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½å¯¼å‡ºPDF
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>${currentFileName}</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Arial, sans-serif; 
                                padding: 20px; 
                                line-height: 1.6; 
                                font-size: 14px;
                            }
                            h1 { 
                                color: #333; 
                                border-bottom: 2px solid #0078d4; 
                                padding-bottom: 10px; 
                                font-size: 24px;
                            }
                            h2 { font-size: 20px; color: #444; }
                            h3 { font-size: 18px; color: #555; }
                            h4 { font-size: 16px; color: #666; }
                            h5, h6 { font-size: 14px; color: #777; }
                            /* ä»£ç å—æ ·å¼ - ç»Ÿä¸€å­—ä½“å¤§å° */
                            pre, code {
                                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                font-size: 13px;
                                line-height: 1.5;
                            }
                            pre {
                                background: #f4f4f4; 
                                padding: 15px; 
                                border-radius: 5px; 
                                white-space: pre-wrap;
                                overflow-x: auto;
                            }
                            code {
                                background: #f0f0f0;
                                padding: 2px 6px;
                                border-radius: 3px;
                            }
                            /* è¡¨æ ¼æ ·å¼ */
                            table {
                                border-collapse: collapse;
                                width: 100%;
                                margin: 15px 0;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 8px;
                                text-align: left;
                            }
                            th {
                                background-color: #f5f5f5;
                                font-weight: bold;
                            }
                            /* åˆ—è¡¨æ ·å¼ */
                            ul, ol {
                                margin: 10px 0;
                                padding-left: 30px;
                            }
                            li {
                                margin: 5px 0;
                            }
                            /* å¼•ç”¨å—æ ·å¼ */
                            blockquote {
                                border-left: 4px solid #0078d4;
                                margin: 10px 0;
                                padding: 10px 20px;
                                background: #f9f9f9;
                            }
                            /* Mermaidå›¾è¡¨å®¹å™¨ */
                            .mermaid {
                                text-align: center;
                                margin: 20px 0;
                            }
                            .mermaid svg {
                                max-width: 100%;
                                height: auto;
                            }
                            /* æ‰“å°ä¼˜åŒ– */
                            @media print {
                                body { padding: 10px; }
                                pre { white-space: pre-wrap; word-wrap: break-word; }
                                .mermaid svg { max-width: 100%; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${currentFileName}</h1>
                        <div>${previewContent.innerHTML}</div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                // å»¶è¿Ÿæ‰“å°ï¼Œç¡®ä¿å†…å®¹åŠ è½½å®Œæˆ
                setTimeout(() => {
                    printWindow.print();
                }, 800);
                
                console.log('PDFå¯¼å‡ºçª—å£å·²æ‰“å¼€ï¼Œè¯·é€‰æ‹©"å¦å­˜ä¸ºPDF"');
            } catch (error) {
                console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
                showNotification('error', 'PDFå¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // ==================== æºç /é¢„è§ˆåˆ‡æ¢åŠŸèƒ½ ====================
        function toggleSourceView() {
            if (!currentFileContent) {
                showNotification('warning', 'è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            isSourceView = !isSourceView;
            updateSourceViewButton();
            
            if (isSourceView) {
                // æ˜¾ç¤ºæºç 
                showSourceView();
            } else {
                // æ¢å¤é¢„è§ˆ
                renderContent(currentFileContent, currentFileName);
            }
        }

        function showSourceView() {
            const preview = document.getElementById('preview');
            preview.innerHTML = `
                <h2 id="file-title-${currentFileName}">${currentFileName}</h2>
                <div class="text-content" style="background: #f8f9fa; border: 1px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
                        <span style="font-weight: bold; color: #666;">ğŸ“„ æºç è§†å›¾</span>
                        <span style="font-size: 12px; color: #999;">${currentFileContent.length} å­—ç¬¦</span>
                    </div>
                    <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px; overflow-x: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${currentFileContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                </div>
            `;
        }

        function updateSourceViewButton() {
            const btn = document.getElementById('source-toggle');
            if (isSourceView) {
                btn.innerHTML = 'ğŸ‘ï¸ é¢„è§ˆ';
                btn.title = 'åˆ‡æ¢å›é¢„è§ˆè§†å›¾';
            } else {
                btn.innerHTML = 'ğŸ“„ æºç ';
                btn.title = 'æŸ¥çœ‹åŸå§‹æºç ';
            }
        }

        function showError(message) {
            const preview = document.getElementById('preview');
            preview.innerHTML = '<div class="error"><h3>é”™è¯¯</h3><p>' + message + '</p></div>';
        }
        
        // ==================== å…¨å±€é”™è¯¯æ•è·ï¼ˆè°ƒè¯•ç”¨é€”ï¼‰====================
        // åˆ›å»ºé”™è¯¯æ—¥å¿—æ•°ç»„ï¼Œä¿å­˜æœ€è¿‘50æ¡é”™è¯¯ï¼Œæ–¹ä¾¿é—®é¢˜åˆ†æ
        window.errorLogs = [];
        const MAX_ERROR_LOGS = 50;
        
        function addErrorLog(type, message, stack) {
            const errorEntry = {
                time: new Date().toLocaleString(),
                type: type,
                message: message,
                stack: stack
            };
            window.errorLogs.unshift(errorEntry);
            if (window.errorLogs.length > MAX_ERROR_LOGS) {
                window.errorLogs.pop();
            }
            // åŒæ—¶åœ¨æ§åˆ¶å°è¾“å‡ºï¼Œæ–¹ä¾¿å¼€å‘è€…æŸ¥çœ‹
            console.log(`[${type}] ${message}`, stack);
        }
        
        // æ•è·åŒæ­¥é”™è¯¯ - åªè®°å½•ä¸é˜»æ­¢ï¼Œä¸å¹²æ‰°Wailsæ¡†æ¶
        window.addEventListener('error', function(event) {
            addErrorLog('Error', event.message, event.error ? event.error.stack : '');
            // è¿”å›falseè¡¨ç¤ºä¸é˜»æ­¢é»˜è®¤å¤„ç†ï¼Œè®©é”™è¯¯æ­£å¸¸æ˜¾ç¤ºåœ¨æ§åˆ¶å°
            return false;
        });
        
        // æ•è·å¼‚æ­¥Promiseé”™è¯¯ - åªè®°å½•ä¸é˜»æ­¢
        window.addEventListener('unhandledrejection', function(event) {
            const reason = event.reason;
            const message = reason instanceof Error ? reason.message : String(reason);
            const stack = reason instanceof Error ? reason.stack : '';
            addErrorLog('Promise', message, stack);
            // ä¸è°ƒç”¨event.preventDefault()ï¼Œè®©é”™è¯¯æ­£å¸¸ä¼ æ’­ï¼Œä¸å¹²æ‰°Wails
        });
        
        // å¯¼å‡ºé”™è¯¯æ—¥å¿—æŸ¥çœ‹å‡½æ•° - å¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°è°ƒç”¨æŸ¥çœ‹é”™è¯¯å†å²
        window.showErrorLogs = function() {
            console.table(window.errorLogs);
            return window.errorLogs;
        };
        
        window.clearErrorLogs = function() {
            window.errorLogs = [];
            console.log('é”™è¯¯æ—¥å¿—å·²æ¸…ç©º');
        };
        
        console.log('å…¨å±€é”™è¯¯æ•è·å·²å¯ç”¨ - è°ƒç”¨ showErrorLogs() æŸ¥çœ‹é”™è¯¯å†å²');
    </script>
    <!-- å¯è§†åŒ–è°ƒè¯•é¢æ¿ -->
    <div id="debug-panel" style="position: fixed; bottom: 0; right: 0; width: 600px; max-height: 400px; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace; font-size: 12px; z-index: 9999; overflow-y: auto; border: 2px solid #0078d4; display: none;">
        <div style="background: #0078d4; color: white; padding: 5px 10px; font-weight: bold; cursor: pointer;" onclick="toggleDebugPanel()">
            ğŸ“‹ è°ƒè¯•ä¿¡æ¯é¢æ¿ (ç‚¹å‡»æ”¶èµ·/å±•å¼€)
        </div>
        <div id="debug-content" style="padding: 10px; max-height: 350px; overflow-y: auto;">
            <div style="color: #888;">ç­‰å¾…åŠ è½½æ–‡ä»¶...</div>
        </div>
    </div>
    
    <script>
        // è°ƒè¯•é¢æ¿åˆ‡æ¢
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const content = document.getElementById('debug-content');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                panel.style.maxHeight = '400px';
            } else {
                content.style.display = 'none';
                panel.style.maxHeight = '30px';
            }
        }
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        // æŒ‰ç±»åˆ«è®¾ç½®é¢œè‰²ï¼ˆæ–¹æ¡ˆAï¼‰
        const categoryColors = {
            'ç›®å½•æå–': '#2196F3',      // è“è‰²
            'escapeHtml': '#F44336',      // çº¢è‰²
            'validateMermaidCode': '#4CAF50', // ç»¿è‰²
            'cleanupMermaidErrorElements': '#FF9800', // æ©™è‰²
            'checkAndCleanupMermaidError': '#9C27B0', // ç´«è‰²
            'ç¬¬ä¸€å±‚é˜²å¾¡': '#4CAF50',      // ç»¿è‰²
            'ç¬¬äºŒå±‚é˜²å¾¡': '#FF9800',      // æ©™è‰²
            'ç¬¬ä¸‰å±‚é˜²å¾¡': '#9C27B0',      // ç´«è‰²
            'Mermaidæ¸²æŸ“': '#2196F3',     // è“è‰²
            'Wordå¯¼å‡º': '#FF9800',        // æ©™è‰²
            'PDFå¯¼å‡º': '#FF9800',         // æ©™è‰²
            'å…¨å±€é”™è¯¯': '#F44336',        // çº¢è‰²
            'é”™è¯¯æ—¥å¿—': '#F44336',        // çº¢è‰²
            'æ¸²æŸ“æµç¨‹': '#2196F3',        // è“è‰²
            'å¯åŠ¨æµ‹è¯•': '#4CAF50',        // ç»¿è‰²
            'ç³»ç»Ÿ': '#888888'             // ç°è‰²
        };
        
        window.addDebugInfo = function(category, message) {
            const content = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.style.cssText = 'margin: 2px 0; border-bottom: 1px solid #333; padding: 2px 0;';
            
            // æŒ‰ç±»åˆ«è·å–é¢œè‰²
            const categoryColor = categoryColors[category] || '#4fc1ff';
            
            line.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${categoryColor}; font-weight: bold;">${category}:</span> ${message}`;
            content.appendChild(line);
            content.scrollTop = content.scrollHeight;
            
            // æ˜¾ç¤ºé¢æ¿
            document.getElementById('debug-panel').style.display = 'block';
        };
        
        // æ¸…ç©ºè°ƒè¯•ä¿¡æ¯
        window.clearDebugInfo = function() {
            document.getElementById('debug-content').innerHTML = '';
        };
        
        // ========== ç¬¬ä¸‰å±‚é˜²å¾¡ï¼šå…¨å±€ç›‘æ§è‡ªåŠ¨æ¸…ç† ==========
        // èŠ‚æµæ§åˆ¶æ ‡å¿—ï¼Œé¿å…é‡å¤å¤„ç†
        let cleanupPending = false;
        
        window.addEventListener('DOMContentLoaded', function() {
            // é¿å…é‡å¤åˆ›å»ºobserver
            if (window.mermaidErrorObserver) {
                console.log('[ä¸‰å±‚é˜²å¾¡] å…¨å±€ç›‘æ§å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤å¯åŠ¨');
                return;
            }
            
            window.mermaidErrorObserver = new MutationObserver(function(mutations) {
                // èŠ‚æµæ£€æŸ¥ï¼šå¦‚æœæ­£åœ¨å¤„ç†ï¼Œè·³è¿‡æœ¬æ¬¡
                if (cleanupPending) return;
                
                let hasCleaned = false;
                
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) {
                            // ä½¿ç”¨è¾…åŠ©å‡½æ•°æ£€æµ‹å¹¶æ¸…ç†é”™è¯¯å…ƒç´ 
                            const cleaned = checkAndCleanupMermaidError(node);
                            if (cleaned) {
                                hasCleaned = true;
                            }
                            
                            // é€’å½’æ£€æŸ¥å­å…ƒç´ 
                            if (node.querySelectorAll) {
                                const errorElements = node.querySelectorAll('[id^="chart-"], [id^="dchart"], [id^="ichart"], svg');
                                errorElements.forEach(function(el) {
                                    if (checkAndCleanupMermaidError(el)) {
                                        hasCleaned = true;
                                    }
                                });
                            }
                        }
                    });
                });
                
                // å¦‚æœæœ‰æ¸…ç†æ“ä½œï¼Œè®¾ç½®èŠ‚æµæ ‡å¿—
                if (hasCleaned) {
                    cleanupPending = true;
                    console.log('[ç¬¬ä¸‰å±‚é˜²å¾¡] å·²æ¸…ç†Mermaidé”™è¯¯å…ƒç´ ');
                    setTimeout(function() {
                        cleanupPending = false;
                    }, 100); // 100msèŠ‚æµ
                }
            });
            
            window.mermaidErrorObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('[ä¸‰å±‚é˜²å¾¡] å…¨å±€ç›‘æ§å·²å¯åŠ¨ï¼ˆå¸¦100msèŠ‚æµï¼‰');
        });
        // ========== ç¬¬ä¸‰å±‚é˜²å¾¡ç»“æŸ ==========
    </script>
</body>
</html>
